{"schemas":"--- original\n+++ modified\n@@ -1,3 +1,65 @@\n+-- Archive Verification Schema\n+-- 归档哈希链验证记录表（由 VerifyScheduler 自动写入）\n+\n+DEFINE TABLE OVERWRITE archive_verification TYPE NORMAL SCHEMAFULL\n+    PERMISSIONS\n+        FOR select WHERE $auth.role = role:admin OR $auth.id = employee:admin\n+        FOR create FULL\n+        FOR update, delete NONE;\n+\n+-- 验证类型\n+DEFINE FIELD OVERWRITE verification_type ON archive_verification TYPE string\n+    ASSERT $value IN [\"daily\", \"full\"]\n+    PERMISSIONS FULL;\n+\n+-- 营业日标签 (daily: \"2026-01-29\", full: None)\n+DEFINE FIELD OVERWRITE date ON archive_verification TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 订单统计\n+DEFINE FIELD OVERWRITE total_orders ON archive_verification TYPE int\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+DEFINE FIELD OVERWRITE verified_orders ON archive_verification TYPE int\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 链路完整性\n+DEFINE FIELD OVERWRITE chain_intact ON archive_verification TYPE bool\n+    DEFAULT true\n+    PERMISSIONS FULL;\n+\n+-- 异常计数\n+DEFINE FIELD OVERWRITE chain_resets_count ON archive_verification TYPE int\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+DEFINE FIELD OVERWRITE chain_breaks_count ON archive_verification TYPE int\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+DEFINE FIELD OVERWRITE invalid_orders_count ON archive_verification TYPE int\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 有异常时存储完整验证结果 JSON\n+DEFINE FIELD OVERWRITE details ON archive_verification TYPE option<object>\n+    PERMISSIONS FULL;\n+\n+-- 时间戳（自动生成，只读）\n+DEFINE FIELD OVERWRITE created_at ON archive_verification TYPE int READONLY\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 索引\n+DEFINE INDEX OVERWRITE av_type_idx ON archive_verification FIELDS verification_type;\n+DEFINE INDEX OVERWRITE av_date_idx ON archive_verification FIELDS date;\n+DEFINE INDEX OVERWRITE av_created_idx ON archive_verification FIELDS created_at;\n+DEFINE INDEX OVERWRITE av_intact_idx ON archive_verification FIELDS chain_intact;\n+-- Fix #3: 去重约束（同类型+同日期只保留一条）\n+DEFINE INDEX OVERWRITE av_type_date_unique ON archive_verification FIELDS verification_type, date UNIQUE;\n+\n -- Attribute Schema (Graph-oriented)\n -- 属性表，选项直接嵌入，使用 RELATE 建立与产品/分类的关系\n\n@@ -83,7 +145,8 @@\n DEFINE INDEX OVERWRITE has_attr_unique ON has_attribute FIELDS in, out UNIQUE;\n\n -- Audit Log Table Schema\n--- 审计日志表，记录系统操作历史\n+-- 税务级审计日志表，SHA256 哈希链防篡改\n+-- Append-only: 不允许 update/delete\n\n DEFINE TABLE OVERWRITE audit_log TYPE NORMAL SCHEMAFULL\n     PERMISSIONS\n@@ -91,57 +154,56 @@\n         FOR create FULL\n         FOR update, delete NONE;\n\n--- 操作类型\n-DEFINE FIELD OVERWRITE action ON audit_log TYPE string\n-    ASSERT $value IN [\n-        'login', 'logout', 'login_failed', 'token_refresh',\n-        'read', 'create', 'update', 'delete',\n-        'config_change', 'user_create', 'user_update', 'user_delete',\n-        'role_change', 'permission_change',\n-        'server_start', 'server_stop', 'backup_create', 'backup_restore',\n-        'unauthorized_access', 'invalid_token'\n-    ]\n+-- 序列号（全局递增，哈希链标识）\n+DEFINE FIELD OVERWRITE sequence ON audit_log TYPE int\n     PERMISSIONS FULL;\n\n--- 操作资源\n-DEFINE FIELD OVERWRITE resource ON audit_log TYPE string\n+-- 时间戳（Unix 毫秒）\n+DEFINE FIELD OVERWRITE timestamp ON audit_log TYPE int\n     PERMISSIONS FULL;\n\n--- 是否成功\n-DEFINE FIELD OVERWRITE success ON audit_log TYPE bool DEFAULT true\n+-- 操作类型（snake_case 字符串，与 Rust AuditAction 枚举对应）\n+DEFINE FIELD OVERWRITE action ON audit_log TYPE string\n     PERMISSIONS FULL;\n\n--- 用户信息（可选）\n-DEFINE FIELD OVERWRITE user_id ON audit_log TYPE option<string>\n+-- 资源类型（如 \"system\", \"auth\", \"order\", \"employee\"）\n+DEFINE FIELD OVERWRITE resource_type ON audit_log TYPE string\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE username ON audit_log TYPE option<string>\n+-- 资源 ID（如 \"server:main\", \"employee:emp1\"）\n+DEFINE FIELD OVERWRITE resource_id ON audit_log TYPE string\n     PERMISSIONS FULL;\n\n--- 请求上下文\n-DEFINE FIELD OVERWRITE ip_address ON audit_log TYPE option<string>\n+-- 操作人 ID（系统事件为 null）\n+DEFINE FIELD OVERWRITE operator_id ON audit_log TYPE option<string>\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE user_agent ON audit_log TYPE option<string>\n+-- 操作人名称\n+DEFINE FIELD OVERWRITE operator_name ON audit_log TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 结构化详情（任意 JSON 对象）\n+DEFINE FIELD OVERWRITE details ON audit_log FLEXIBLE TYPE object DEFAULT {}\n     PERMISSIONS FULL;\n\n--- 详情\n-DEFINE FIELD OVERWRITE details ON audit_log TYPE option<string>\n+-- 关联目标（可选，指向相关审计条目或资源，如 \"system_issue:xxx\"）\n+DEFINE FIELD OVERWRITE target ON audit_log TYPE option<string>\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE error ON audit_log TYPE option<string>\n+-- SHA256 哈希链 — 前一条审计日志哈希\n+DEFINE FIELD OVERWRITE prev_hash ON audit_log TYPE string\n     PERMISSIONS FULL;\n\n--- 时间戳（自动生成，只读）\n-DEFINE FIELD OVERWRITE created_at ON audit_log TYPE datetime VALUE time::now() READONLY\n+-- SHA256 哈希链 — 当前记录哈希\n+DEFINE FIELD OVERWRITE curr_hash ON audit_log TYPE string\n     PERMISSIONS FULL;\n\n -- 索引\n+DEFINE INDEX OVERWRITE audit_sequence_idx ON audit_log FIELDS sequence UNIQUE;\n+DEFINE INDEX OVERWRITE audit_timestamp_idx ON audit_log FIELDS timestamp;\n DEFINE INDEX OVERWRITE audit_action_idx ON audit_log FIELDS action;\n-DEFINE INDEX OVERWRITE audit_user_idx ON audit_log FIELDS user_id;\n-DEFINE INDEX OVERWRITE audit_resource_idx ON audit_log FIELDS resource;\n-DEFINE INDEX OVERWRITE audit_created_idx ON audit_log FIELDS created_at;\n-DEFINE INDEX OVERWRITE audit_success_idx ON audit_log FIELDS success;\n+DEFINE INDEX OVERWRITE audit_operator_idx ON audit_log FIELDS operator_id;\n+DEFINE INDEX OVERWRITE audit_resource_type_idx ON audit_log FIELDS resource_type;\n\n -- Category Table Schema\n -- 产品分类表\n@@ -199,6 +261,114 @@\n DEFINE INDEX OVERWRITE category_name_unique ON category FIELDS name UNIQUE;\n DEFINE INDEX OVERWRITE category_sort_order ON category FIELDS sort_order;\n\n+-- Daily Report Schema\n+-- 日结报告表\n+\n+DEFINE TABLE OVERWRITE daily_report TYPE NORMAL SCHEMAFULL\n+    PERMISSIONS\n+        FOR select, create, update, delete\n+            WHERE $auth.role = role:admin OR $auth.id = employee:admin;\n+\n+-- 营业日期 (YYYY-MM-DD)\n+DEFINE FIELD OVERWRITE business_date ON daily_report TYPE string\n+    ASSERT string::len($value) = 10\n+    PERMISSIONS FULL;\n+\n+-- === 订单统计 ===\n+\n+-- 总订单数\n+DEFINE FIELD OVERWRITE total_orders ON daily_report TYPE int\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 完成订单数\n+DEFINE FIELD OVERWRITE completed_orders ON daily_report TYPE int\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 作废订单数\n+DEFINE FIELD OVERWRITE void_orders ON daily_report TYPE int\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- === 金额统计 ===\n+\n+-- 总营业额 (completed orders)\n+DEFINE FIELD OVERWRITE total_sales ON daily_report TYPE float\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 已支付金额\n+DEFINE FIELD OVERWRITE total_paid ON daily_report TYPE float\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 未支付金额\n+DEFINE FIELD OVERWRITE total_unpaid ON daily_report TYPE float\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 作废订单金额\n+DEFINE FIELD OVERWRITE void_amount ON daily_report TYPE float\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 税额总计\n+DEFINE FIELD OVERWRITE total_tax ON daily_report TYPE float\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 折扣总计\n+DEFINE FIELD OVERWRITE total_discount ON daily_report TYPE float\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 附加费总计\n+DEFINE FIELD OVERWRITE total_surcharge ON daily_report TYPE float\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- === 税率分类 (西班牙 IVA) ===\n+DEFINE FIELD OVERWRITE tax_breakdowns ON daily_report TYPE array<object>\n+    DEFAULT []\n+    PERMISSIONS FULL;\n+\n+DEFINE FIELD OVERWRITE tax_breakdowns.*.tax_rate ON daily_report TYPE int PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE tax_breakdowns.*.net_amount ON daily_report TYPE float DEFAULT 0 PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE tax_breakdowns.*.tax_amount ON daily_report TYPE float DEFAULT 0 PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE tax_breakdowns.*.gross_amount ON daily_report TYPE float DEFAULT 0 PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE tax_breakdowns.*.order_count ON daily_report TYPE int DEFAULT 0 PERMISSIONS FULL;\n+\n+-- === 支付方式分类 ===\n+DEFINE FIELD OVERWRITE payment_breakdowns ON daily_report TYPE array<object>\n+    DEFAULT []\n+    PERMISSIONS FULL;\n+\n+DEFINE FIELD OVERWRITE payment_breakdowns.*.method ON daily_report TYPE string PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE payment_breakdowns.*.amount ON daily_report TYPE float DEFAULT 0 PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE payment_breakdowns.*.count ON daily_report TYPE int DEFAULT 0 PERMISSIONS FULL;\n+\n+-- === 生成信息 ===\n+\n+-- 生成时间 (Unix timestamp millis)\n+DEFINE FIELD OVERWRITE generated_at ON daily_report TYPE option<int>\n+    PERMISSIONS FULL;\n+\n+-- 生成人 ID\n+DEFINE FIELD OVERWRITE generated_by_id ON daily_report TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 生成人姓名\n+DEFINE FIELD OVERWRITE generated_by_name ON daily_report TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 备注\n+DEFINE FIELD OVERWRITE note ON daily_report TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 索引\n+DEFINE INDEX OVERWRITE daily_report_date_unique ON daily_report FIELDS business_date UNIQUE;\n+\n -- Dining Table Schema\n -- 桌台表\n\n@@ -282,8 +452,7 @@\n     PERMISSIONS FULL;\n\n -- 创建时间\n-DEFINE FIELD OVERWRITE created_at ON image_ref TYPE datetime\n-    DEFAULT time::now()\n+DEFINE FIELD OVERWRITE created_at ON image_ref TYPE int\n     PERMISSIONS FULL;\n\n -- 唯一索引：同一实体对同一图片只记录一次\n@@ -295,6 +464,98 @@\n -- 实体索引：快速查找实体的所有图片引用\n DEFINE INDEX OVERWRITE idx_image_ref_entity ON image_ref FIELDS entity_type, entity_id;\n\n+-- Label Template Schema\n+-- 标签打印模板表\n+\n+DEFINE TABLE OVERWRITE label_template TYPE NORMAL SCHEMAFULL\n+    PERMISSIONS\n+        FOR select, create, update, delete\n+            WHERE $auth.role = role:admin OR $auth.id = employee:admin;\n+\n+-- 模板名称\n+DEFINE FIELD OVERWRITE name ON label_template TYPE string\n+    ASSERT string::len($value) > 0\n+    PERMISSIONS FULL;\n+\n+-- 模板描述\n+DEFINE FIELD OVERWRITE description ON label_template TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 标签宽度 (mm)\n+DEFINE FIELD OVERWRITE width ON label_template TYPE float\n+    PERMISSIONS FULL;\n+\n+-- 标签高度 (mm)\n+DEFINE FIELD OVERWRITE height ON label_template TYPE float\n+    PERMISSIONS FULL;\n+\n+-- 内边距 (mm)\n+DEFINE FIELD OVERWRITE padding ON label_template TYPE float\n+    DEFAULT 2.0\n+    PERMISSIONS FULL;\n+\n+-- 模板字段列表 (嵌入式数组)\n+DEFINE FIELD OVERWRITE fields ON label_template TYPE array<object>\n+    DEFAULT []\n+    PERMISSIONS FULL;\n+\n+DEFINE FIELD OVERWRITE fields.*.id ON label_template TYPE string PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.name ON label_template TYPE string PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.type ON label_template TYPE string\n+    ASSERT $value IN [\"text\", \"barcode\", \"qrcode\", \"image\", \"separator\", \"datetime\", \"price\", \"counter\"]\n+    PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.x ON label_template TYPE float PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.y ON label_template TYPE float PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.width ON label_template TYPE float PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.height ON label_template TYPE float PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.font_size ON label_template TYPE int DEFAULT 10 PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.font_weight ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.font_family ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.color ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.rotate ON label_template TYPE option<int> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.alignment ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.data_source ON label_template TYPE string PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.format ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.visible ON label_template TYPE bool DEFAULT true PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.label ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.template ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.data_key ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.source_type ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.maintain_aspect_ratio ON label_template TYPE option<bool> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.style ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.align ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.vertical_align ON label_template TYPE option<string> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE fields.*.line_style ON label_template TYPE option<string> PERMISSIONS FULL;\n+\n+-- 是否默认模板\n+DEFINE FIELD OVERWRITE is_default ON label_template TYPE bool\n+    DEFAULT false\n+    PERMISSIONS FULL;\n+\n+-- 是否启用\n+DEFINE FIELD OVERWRITE is_active ON label_template TYPE bool\n+    DEFAULT true\n+    PERMISSIONS FULL;\n+\n+-- UI 兼容字段\n+DEFINE FIELD OVERWRITE width_mm ON label_template TYPE option<float> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE height_mm ON label_template TYPE option<float> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE padding_mm_x ON label_template TYPE option<float> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE padding_mm_y ON label_template TYPE option<float> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE render_dpi ON label_template TYPE option<int> PERMISSIONS FULL;\n+DEFINE FIELD OVERWRITE test_data ON label_template TYPE option<string> PERMISSIONS FULL;\n+\n+-- 时间戳\n+DEFINE FIELD OVERWRITE created_at ON label_template TYPE option<int>\n+    PERMISSIONS FULL;\n+\n+DEFINE FIELD OVERWRITE updated_at ON label_template TYPE option<int>\n+    PERMISSIONS FULL;\n+\n+-- 索引\n+DEFINE INDEX OVERWRITE label_template_name_idx ON label_template FIELDS name;\n+DEFINE INDEX OVERWRITE label_template_active_idx ON label_template FIELDS is_active;\n+\n -- Order Schema (Graph Model)\n -- 归档订单使用图边关系，只存储核心数据\n\n@@ -356,11 +617,10 @@\n     DEFAULT 0\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE start_time ON order TYPE datetime\n-    DEFAULT time::now()\n+DEFINE FIELD OVERWRITE start_time ON order TYPE int\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE end_time ON order TYPE option<datetime>\n+DEFINE FIELD OVERWRITE end_time ON order TYPE option<int>\n     PERMISSIONS FULL;\n\n DEFINE FIELD OVERWRITE operator_id ON order TYPE option<string>\n@@ -378,8 +638,7 @@\n DEFINE FIELD OVERWRITE curr_hash ON order TYPE string\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE created_at ON order TYPE datetime\n-    DEFAULT time::now()\n+DEFINE FIELD OVERWRITE created_at ON order TYPE int\n     PERMISSIONS FULL;\n\n DEFINE INDEX OVERWRITE order_receipt ON order FIELDS receipt_number UNIQUE;\n@@ -447,6 +706,9 @@\n DEFINE FIELD OVERWRITE note ON order_item TYPE option<string>\n     PERMISSIONS FULL;\n\n+DEFINE FIELD OVERWRITE category_name ON order_item TYPE option<string>\n+    PERMISSIONS FULL;\n+\n DEFINE INDEX OVERWRITE order_item_spec ON order_item FIELDS spec;\n DEFINE INDEX OVERWRITE order_item_instance ON order_item FIELDS instance_id;\n\n@@ -485,8 +747,7 @@\n     DEFAULT 0\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE time ON order_payment TYPE datetime\n-    DEFAULT time::now()\n+DEFINE FIELD OVERWRITE time ON order_payment TYPE int\n     PERMISSIONS FULL;\n\n DEFINE FIELD OVERWRITE reference ON order_payment TYPE option<string>\n@@ -517,8 +778,7 @@\n DEFINE FIELD OVERWRITE event_type ON order_event TYPE string\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE timestamp ON order_event TYPE datetime\n-    DEFAULT time::now()\n+DEFINE FIELD OVERWRITE timestamp ON order_event TYPE int\n     PERMISSIONS FULL;\n\n DEFINE FIELD OVERWRITE data ON order_event TYPE option<string>\n@@ -556,6 +816,49 @@\n     PERMISSIONS FOR select, create\n         WHERE $auth.role = role:admin OR $auth.id = employee:admin;\n\n+-- Payment 独立表：支付记录（从订单事件溯源投影）\n+-- 归档时写入，方便统计和对账\n+\n+DEFINE TABLE IF NOT EXISTS payment TYPE NORMAL SCHEMAFULL\n+    PERMISSIONS\n+        FOR select, create, update WHERE true\n+        FOR delete NONE;\n+\n+-- 核心字段\n+DEFINE FIELD IF NOT EXISTS payment_id    ON payment TYPE string;\n+DEFINE FIELD IF NOT EXISTS order_id      ON payment TYPE string;\n+DEFINE FIELD IF NOT EXISTS method        ON payment TYPE string;        -- CASH / CARD\n+DEFINE FIELD IF NOT EXISTS amount        ON payment TYPE float;\n+DEFINE FIELD IF NOT EXISTS tendered      ON payment TYPE option<float>; -- 现金实收\n+DEFINE FIELD IF NOT EXISTS change_amount ON payment TYPE option<float>; -- 找零\n+DEFINE FIELD IF NOT EXISTS note          ON payment TYPE option<string>;\n+\n+-- 分单上下文\n+DEFINE FIELD IF NOT EXISTS split_type    ON payment TYPE option<string>; -- ItemSplit / AmountSplit / AaSplit / null\n+DEFINE FIELD IF NOT EXISTS aa_shares     ON payment TYPE option<int>;\n+DEFINE FIELD IF NOT EXISTS split_items   ON payment TYPE option<string>; -- JSON string [{name, quantity, unit_price}]\n+\n+-- 操作人\n+DEFINE FIELD IF NOT EXISTS operator_id   ON payment TYPE option<string>;\n+DEFINE FIELD IF NOT EXISTS operator_name ON payment TYPE option<string>;\n+\n+-- 取消\n+DEFINE FIELD IF NOT EXISTS cancelled     ON payment TYPE bool DEFAULT false;\n+DEFINE FIELD IF NOT EXISTS cancel_reason ON payment TYPE option<string>;\n+\n+-- 时间\n+DEFINE FIELD IF NOT EXISTS timestamp     ON payment TYPE int;   -- 支付时间 (unix ms)\n+DEFINE FIELD IF NOT EXISTS created_at    ON payment TYPE int;    -- 记录创建时间\n+\n+-- 索引\n+DEFINE INDEX IF NOT EXISTS idx_payment_id  ON payment FIELDS payment_id UNIQUE;\n+DEFINE INDEX IF NOT EXISTS idx_order_id    ON payment FIELDS order_id;\n+DEFINE INDEX IF NOT EXISTS idx_method      ON payment FIELDS method;\n+DEFINE INDEX IF NOT EXISTS idx_split_type  ON payment FIELDS split_type;\n+DEFINE INDEX IF NOT EXISTS idx_timestamp   ON payment FIELDS timestamp;\n+DEFINE INDEX IF NOT EXISTS idx_operator    ON payment FIELDS operator_id;\n+DEFINE INDEX IF NOT EXISTS idx_cancelled   ON payment FIELDS cancelled;\n+\n -- Price Rule Schema\n -- 价格调整规则（折扣/附加费）\n\n@@ -619,11 +922,11 @@\n     PERMISSIONS FULL;\n\n -- 有效期开始时间\n-DEFINE FIELD OVERWRITE valid_from ON price_rule TYPE option<datetime>\n+DEFINE FIELD OVERWRITE valid_from ON price_rule TYPE option<int>\n     PERMISSIONS FULL;\n\n -- 有效期结束时间\n-DEFINE FIELD OVERWRITE valid_until ON price_rule TYPE option<datetime>\n+DEFINE FIELD OVERWRITE valid_until ON price_rule TYPE option<int>\n     PERMISSIONS FULL;\n\n -- 活动日 (0=周日, 1=周一, ..., 6=周六)\n@@ -645,8 +948,7 @@\n DEFINE FIELD OVERWRITE created_by ON price_rule TYPE option<record<employee>>\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE created_at ON price_rule TYPE datetime\n-    DEFAULT time::now()\n+DEFINE FIELD OVERWRITE created_at ON price_rule TYPE int\n     PERMISSIONS FULL;\n\n DEFINE INDEX OVERWRITE rule_active ON price_rule FIELDS is_active, product_scope;\n@@ -842,6 +1144,200 @@\n\n DEFINE FIELD OVERWRITE checksum ON script_migration TYPE option<string>;\n\n+-- Shift Schema\n+-- 班次管理表\n+\n+DEFINE TABLE OVERWRITE shift TYPE NORMAL SCHEMAFULL\n+    PERMISSIONS\n+        FOR select, create, update, delete\n+            WHERE $auth.role = role:admin OR $auth.id = employee:admin;\n+\n+-- 操作员 ID（关联 employee 表）\n+DEFINE FIELD OVERWRITE operator_id ON shift TYPE record<employee>\n+    PERMISSIONS FULL;\n+\n+-- 操作员姓名快照\n+DEFINE FIELD OVERWRITE operator_name ON shift TYPE string\n+    PERMISSIONS FULL;\n+\n+-- 班次状态\n+DEFINE FIELD OVERWRITE status ON shift TYPE string\n+    DEFAULT \"OPEN\"\n+    ASSERT $value IN [\"OPEN\", \"CLOSED\"]\n+    PERMISSIONS FULL;\n+\n+-- 开班时间 (Unix timestamp millis)\n+DEFINE FIELD OVERWRITE start_time ON shift TYPE int\n+    PERMISSIONS FULL;\n+\n+-- 收班时间 (Unix timestamp millis)\n+DEFINE FIELD OVERWRITE end_time ON shift TYPE option<int>\n+    PERMISSIONS FULL;\n+\n+-- 备用金 (开班时的现金准备金)\n+DEFINE FIELD OVERWRITE starting_cash ON shift TYPE float\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 预期现金 (starting_cash + 班次内现金收款)\n+DEFINE FIELD OVERWRITE expected_cash ON shift TYPE float\n+    DEFAULT 0\n+    PERMISSIONS FULL;\n+\n+-- 实际现金 (收班时盘点)\n+DEFINE FIELD OVERWRITE actual_cash ON shift TYPE option<float>\n+    PERMISSIONS FULL;\n+\n+-- 现金差异 (actual_cash - expected_cash)\n+DEFINE FIELD OVERWRITE cash_variance ON shift TYPE option<float>\n+    PERMISSIONS FULL;\n+\n+-- 是否异常关闭 (断电/崩溃后自动恢复)\n+DEFINE FIELD OVERWRITE abnormal_close ON shift TYPE bool\n+    DEFAULT false\n+    PERMISSIONS FULL;\n+\n+-- 最后活动时间 (心跳, Unix timestamp millis)\n+DEFINE FIELD OVERWRITE last_active_at ON shift TYPE option<int>\n+    PERMISSIONS FULL;\n+\n+-- 备注\n+DEFINE FIELD OVERWRITE note ON shift TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 时间戳\n+DEFINE FIELD OVERWRITE created_at ON shift TYPE option<int>\n+    PERMISSIONS FULL;\n+\n+DEFINE FIELD OVERWRITE updated_at ON shift TYPE option<int>\n+    PERMISSIONS FULL;\n+\n+-- 索引\n+DEFINE INDEX OVERWRITE shift_status_idx ON shift FIELDS status;\n+DEFINE INDEX OVERWRITE shift_operator_idx ON shift FIELDS operator_id;\n+DEFINE INDEX OVERWRITE shift_start_time_idx ON shift FIELDS start_time;\n+\n+-- Store Info Schema\n+-- 店铺信息表（单例，每个租户只有一条记录 store_info:main）\n+\n+DEFINE TABLE OVERWRITE store_info TYPE NORMAL SCHEMAFULL\n+    PERMISSIONS\n+        FOR select, create, update, delete\n+            WHERE $auth.role = role:admin OR $auth.id = employee:admin;\n+\n+-- 店铺名称\n+DEFINE FIELD OVERWRITE name ON store_info TYPE string\n+    DEFAULT \"\"\n+    PERMISSIONS FULL;\n+\n+-- 店铺地址\n+DEFINE FIELD OVERWRITE address ON store_info TYPE string\n+    DEFAULT \"\"\n+    PERMISSIONS FULL;\n+\n+-- 税号 / 营业执照 (NIF)\n+DEFINE FIELD OVERWRITE nif ON store_info TYPE string\n+    DEFAULT \"\"\n+    PERMISSIONS FULL;\n+\n+-- Logo URL\n+DEFINE FIELD OVERWRITE logo_url ON store_info TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 联系电话\n+DEFINE FIELD OVERWRITE phone ON store_info TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 电子邮箱\n+DEFINE FIELD OVERWRITE email ON store_info TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 官方网站\n+DEFINE FIELD OVERWRITE website ON store_info TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 营业日分界时间 (HH:MM 格式，如 \"06:00\")\n+-- 用于跨天班次判断和日结报告计算\n+-- 默认 \"00:00\" (午夜)，酒吧/夜店可设置为 \"06:00\"\n+DEFINE FIELD OVERWRITE business_day_cutoff ON store_info TYPE string\n+    DEFAULT \"00:00\"\n+    PERMISSIONS FULL;\n+\n+-- 时间戳\n+DEFINE FIELD OVERWRITE created_at ON store_info TYPE option<int>\n+    PERMISSIONS FULL;\n+\n+DEFINE FIELD OVERWRITE updated_at ON store_info TYPE option<int>\n+    PERMISSIONS FULL;\n+\n+-- System Issue Schema\n+-- 系统问题表：本地异常检测和远程服务器推送的问题\n+-- 前端按协议渲染对话框（阻塞式/通知式）\n+\n+DEFINE TABLE OVERWRITE system_issue TYPE NORMAL SCHEMAFULL\n+    PERMISSIONS\n+        FOR select, create, update WHERE true\n+        FOR delete NONE;\n+\n+-- 来源: \"local\" (本地检测) | \"remote\" (远程推送)\n+DEFINE FIELD OVERWRITE source ON system_issue TYPE string\n+    PERMISSIONS FULL;\n+\n+-- 问题类型标识，同时作为前端 i18n key\n+-- 例: \"abnormal_shutdown\", \"long_downtime\", \"subscription_expiring\", \"custom_notice\"\n+DEFINE FIELD OVERWRITE kind ON system_issue TYPE string\n+    PERMISSIONS FULL;\n+\n+-- 是否阻塞 POS 操作 (true=全屏遮罩不可关闭, false=可关闭通知)\n+DEFINE FIELD OVERWRITE blocking ON system_issue TYPE bool\n+    PERMISSIONS FULL;\n+\n+-- 关联实体 (可选, \"table:id\" 格式, 如 \"order:abc123\")\n+DEFINE FIELD OVERWRITE target ON system_issue TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- i18n 动态插值参数 (如 {\"days\": \"7\", \"hours\": \"48\"})\n+DEFINE FIELD OVERWRITE params ON system_issue FLEXIBLE TYPE object DEFAULT {}\n+    PERMISSIONS FULL;\n+\n+-- 远程广播用: 标题文本 (本地问题留空, 前端用 kind 查 i18n)\n+DEFINE FIELD OVERWRITE title ON system_issue TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 远程广播用: 描述文本\n+DEFINE FIELD OVERWRITE description ON system_issue TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 预定义选项 (远程广播直接填文本, 本地问题填 i18n key)\n+DEFINE FIELD OVERWRITE options ON system_issue TYPE array DEFAULT []\n+    PERMISSIONS FULL;\n+\n+-- 状态: \"pending\" | \"resolved\"\n+DEFINE FIELD OVERWRITE status ON system_issue TYPE string\n+    DEFAULT \"pending\"\n+    PERMISSIONS FULL;\n+\n+-- 用户选择的选项或输入的文本\n+DEFINE FIELD OVERWRITE response ON system_issue TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 操作员 ID\n+DEFINE FIELD OVERWRITE resolved_by ON system_issue TYPE option<string>\n+    PERMISSIONS FULL;\n+\n+-- 回应时间戳 (Unix 毫秒)\n+DEFINE FIELD OVERWRITE resolved_at ON system_issue TYPE option<int>\n+    PERMISSIONS FULL;\n+\n+-- 创建时间戳 (Unix 毫秒)\n+DEFINE FIELD OVERWRITE created_at ON system_issue TYPE int\n+    PERMISSIONS FULL;\n+\n+-- 索引\n+DEFINE INDEX OVERWRITE idx_system_issue_status ON system_issue FIELDS status;\n+DEFINE INDEX OVERWRITE idx_system_issue_kind ON system_issue FIELDS kind;\n+DEFINE INDEX OVERWRITE idx_system_issue_source ON system_issue FIELDS source;\n+\n -- System State Schema\n -- 系统状态表（哈希链状态缓存，单例）\n\n@@ -868,7 +1364,7 @@\n DEFINE FIELD OVERWRITE synced_up_to_hash ON system_state TYPE option<string>\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE last_sync_time ON system_state TYPE option<datetime>\n+DEFINE FIELD OVERWRITE last_sync_time ON system_state TYPE option<int>\n     PERMISSIONS FULL;\n\n -- 统计\n@@ -876,12 +1372,12 @@\n     DEFAULT 0\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE created_at ON system_state TYPE datetime\n-    DEFAULT time::now()\n+DEFINE FIELD OVERWRITE created_at ON system_state TYPE int\n+    DEFAULT 0\n     PERMISSIONS FULL;\n\n-DEFINE FIELD OVERWRITE updated_at ON system_state TYPE datetime\n-    DEFAULT time::now()\n+DEFINE FIELD OVERWRITE updated_at ON system_state TYPE int\n+    DEFAULT 0\n     PERMISSIONS FULL;\n\n -- Tag Table Schema\n","events":null}