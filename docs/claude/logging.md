# 日志规范 (tracing)

## 语言与格式

| 规则 | 说明 |
|------|------|
| **语言** | 日志消息统一英文，代码注释可以中文 |
| **无 emoji** | 日志消息禁止 emoji，用文本标签替代（如 `[STARTUP]`, `[TLS]`） |
| **结构化字段** | 优先用 `tracing::info!(order_id = %id, "Order completed")` 而非字符串拼接 |
| **无方括号前缀** | 禁止 `[function_name]` 调试前缀，用 `#[instrument]` 或 `target` 替代 |

## 级别选择

| 级别 | 适用场景 | 示例 |
|------|----------|------|
| **error** | 需要人工介入的故障，数据可能丢失 | 归档失败、存储损坏、关键通道关闭 |
| **warn** | 可自动恢复的异常，降级运行 | 重连中、缓存未命中回退、权限拒绝 |
| **info** | 业务里程碑，低频事件 | 服务启动/停止、用户登录/登出、订单完成、设备激活 |
| **debug** | 内部流程细节，开发排查用 | 命令处理过程、消息转发、缓存操作、锁获取 |
| **trace** | 极高频协议细节 | 心跳 pong、逐帧数据 |

## info 准入标准

以下场景**适合** info：
- 服务/Worker 启动和停止（每个生命周期各一条）
- 用户登录/登出（权威层记一次）
- 订单状态终结（Completed/Voided/Merged）
- 设备激活/停用
- TLS/mTLS 配置变更
- 异常恢复成功（如重连成功）

以下场景**禁止** info，应用 debug 或删除：
- 每次 HTTP 请求的处理细节（access log 用独立 `target: "http_access"`）
- 消息总线每条消息的收发
- 广播/同步的常规成功
- 锁获取/释放
- 内部初始化步骤（用最终结果一条 info 代替多条过程 info）
- 周期性任务的"无事发生"（如"No records to cleanup"）

## 单一权威点

同一业务操作只在**权威层**记录一次，避免跨层重复：
- 登录：`edge-server/api/auth` 记录，`bridge` 和 `crab-client` 不重复记录
- 命令处理：`OrdersManager` 记录结果，调用方不重复记录
- 消息转发：发送端或接收端记录一次，不两头都记

## 禁止事项

- 禁止使用 `println!` / `eprintln!`（全部用 `tracing` 宏）
- 禁止使用 `log::` crate（统一用 `tracing`）
- 禁止在日志中输出密码、JWT token、证书私钥等敏感数据
- 禁止在 info 级别记录每次请求/消息的细节（用 debug）
- 禁止"成功是常态"的冗余确认日志（如 `debug!("Sync broadcast successful")`，删除）
- 禁止中文日志消息（日志统一英文）
