# Crab é¡¹ç›®å…¨é¢åˆ†ææŠ¥å‘Š

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **ç”Ÿæˆæ—¥æœŸ**: 2026-01-16  
> **é¡¹ç›®çŠ¶æ€**: Feasibility Testing / Prototype  
> **åˆ†ææ·±åº¦**: æ¶æ„ + é£é™© + ä¼˜åŒ– + å¯æ‰§è¡Œä»»åŠ¡

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æ¶æ„åˆ†æ](#2-æ¶æ„åˆ†æ)
3. [ç»„ä»¶è¯¦ç»†åˆ†æ](#3-ç»„ä»¶è¯¦ç»†åˆ†æ)
4. [é£é™©è¯„ä¼°](#4-é£é™©è¯„ä¼°)
5. [ä¼˜åŒ–å»ºè®®](#5-ä¼˜åŒ–å»ºè®®)
6. [è¡ŒåŠ¨ä»»åŠ¡æ¸…å•](#6-è¡ŒåŠ¨ä»»åŠ¡æ¸…å•)
7. [è¿½è¸ªè¿›åº¦](#7-è¿½è¸ªè¿›åº¦)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

Crab æ˜¯ä¸€ä¸ª**åˆ†å¸ƒå¼é¤å…ç®¡ç†ç³»ç»Ÿ**ï¼Œé‡‡ç”¨ Rust å®ç°ï¼Œèšç„¦äºï¼š

| ç‰¹æ€§ | æè¿° |
|------|------|
| **è¾¹ç¼˜è®¡ç®—** | Edge Server æ¶æ„ï¼Œè‡ªåŒ…å«ã€ç¦»çº¿å¯ç”¨ |
| **å®‰å…¨é€šä¿¡** | mTLS ä¸‰å±‚è¯ä¹¦ä½“ç³»ï¼Œç¡¬ä»¶ç»‘å®š |
| **å¼ºç±»å‹** | åè®®æ¶ˆæ¯ä½¿ç”¨ serde åºåˆ—åŒ–ï¼Œç±»å‹å®‰å…¨ |
| **å¤šç§Ÿæˆ·** | æ”¯æŒç§Ÿæˆ·éš”ç¦»ï¼Œç‹¬ç«‹è¯ä¹¦é“¾ |

### 1.2 æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æŠ€æœ¯æ ˆæ¦‚è§ˆ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¯­è¨€        â”‚  Rust (Edition 2024)                         â”‚
â”‚  Web æ¡†æ¶    â”‚  Axum                                        â”‚
â”‚  æ•°æ®åº“      â”‚  SurrealDB (åµŒå…¥å¼)                          â”‚
â”‚  æ¶ˆæ¯æ€»çº¿    â”‚  Tokio Broadcast + è‡ªå®šä¹‰ Transport          â”‚
â”‚  è¯ä¹¦/åŠ å¯†   â”‚  rcgen, x509-parser, rustls                  â”‚
â”‚  è®¤è¯        â”‚  JWT (jsonwebtoken) + Argon2                â”‚
â”‚  è¿è¡Œæ—¶      â”‚  Tokio                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æ¨¡å—ç»“æ„

```
crab/
â”œâ”€â”€ shared/              # å…±äº«ç±»å‹ä¸åè®®å®šä¹‰
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ message/     # æ¶ˆæ¯æ€»çº¿åè®® (æ ¸å¿ƒ)
â”‚       â”œâ”€â”€ types.rs     # å…±äº«ç±»å‹
â”‚       â””â”€â”€ lib.rs       # å…¬å…±å¯¼å‡º
â”‚
â”œâ”€â”€ edge-server/         # è¾¹ç¼˜æœåŠ¡å™¨ (æ ¸å¿ƒ)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ server/      # æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸä¸çŠ¶æ€
â”‚       â”œâ”€â”€ message/     # æ¶ˆæ¯æ€»çº¿å®ç°
â”‚       â”œâ”€â”€ routes/      # HTTP è·¯ç”±
â”‚       â”œâ”€â”€ handler/     # ä¸šåŠ¡å¤„ç†å™¨
â”‚       â””â”€â”€ db/          # æ•°æ®åº“æ¨¡å‹
â”‚
â”œâ”€â”€ crab-client/         # ç»Ÿä¸€å®¢æˆ·ç«¯åº“
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ http/        # HTTP å®¢æˆ·ç«¯
â”‚       â””â”€â”€ message/     # æ¶ˆæ¯å®¢æˆ·ç«¯
â”‚
â”œâ”€â”€ crab-cert/           # PKI è¯ä¹¦ç®¡ç†
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ ca.rs        # è¯ä¹¦é¢å‘æœºæ„
â”‚       â”œâ”€â”€ crypto.rs    # åŠ å¯†æ“ä½œ
â”‚       â””â”€â”€ machine.rs   # ç¡¬ä»¶ ID ç”Ÿæˆ
â”‚
â””â”€â”€ crab-auth/           # è®¤è¯æœåŠ¡å™¨ (Port 3001)
```

---

## 2. æ¶æ„åˆ†æ

### 2.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Crab ç³»ç»Ÿæ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚   Crab Client   â”‚â—„â”€â”€â”€â”€â”€ HTTP/mTLS â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Edge Server   â”‚          â”‚
â”‚   â”‚                 â”‚                          â”‚   (Port 3000)   â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                         â”‚                   â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                                          â”‚              â”‚              â”‚    â”‚
â”‚                                          â–¼              â–¼              â–¼    â”‚
â”‚                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                  â”‚  SurrealDB  â”‚ â”‚ Message  â”‚ â”‚  Cert   â”‚  â”‚
â”‚                                  â”‚  (Embedded) â”‚ â”‚   Bus    â”‚ â”‚ Service â”‚  â”‚
â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         Message Bus æ¶æ„                             â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚   â”‚                    Transport Layer                           â”‚   â”‚  â”‚
â”‚   â”‚   â”‚   TcpTransport  â”‚  TlsTransport  â”‚  MemoryTransport         â”‚   â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â”‚                    â”‚               â”‚                                  â”‚  â”‚
â”‚   â”‚                    â–¼               â–¼                                  â”‚  â”‚
â”‚   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚   â”‚              â”‚         broadcast::Sender<BusMessage>       â”‚        â”‚  â”‚
â”‚   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         mTLS è¯ä¹¦ä½“ç³»                                 â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚      Root CA â”€â”€â–º Tenant CA â”€â”€â–º Edge Server Cert                     â”‚  â”‚
â”‚   â”‚                       â””â”€â”€â–º Client Certs                             â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚      ç¡¬ä»¶ ID ç»‘å®š â”€â”€â–º è¯ä¹¦åŒ…å« device_id â”€â”€â–º è‡ªæ£€éªŒè¯                â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµåˆ†æ

#### 2.2.1 è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·è®¤è¯æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Client                          Edge Server                       â”‚
â”‚     â”‚                                 â”‚                              â”‚
â”‚     â”‚  1. POST /api/auth/login        â”‚                              â”‚
â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                         â”‚
â”‚     â”‚         username, password       â”‚                              â”‚
â”‚     â”‚                                 â”‚                              â”‚
â”‚     â”‚                          2. æŸ¥è¯¢ employee                      â”‚
â”‚     â”‚                          3. éªŒè¯ argon2 å¯†ç                    â”‚
â”‚     â”‚                          4. æŸ¥è¯¢ role & permissions            â”‚
â”‚     â”‚                          5. ç”Ÿæˆ JWT                           â”‚
â”‚     â”‚                                 â”‚                              â”‚
â”‚     â”‚  6. JWT Token â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚     â”‚         token, user info         â”‚                              â”‚
â”‚     â”‚                                 â”‚                              â”‚
â”‚     â”‚  7. åç»­è¯·æ±‚æºå¸¦ JWT            â”‚                              â”‚
â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                         â”‚
â”‚     â”‚         Authorization: Bearer <token>                          â”‚
â”‚     â”‚                                 â”‚                              â”‚
â”‚     â”‚                          8. JWT éªŒè¯ä¸­é—´ä»¶                      â”‚
â”‚     â”‚                          9. æ³¨å…¥ CurrentUser                   â”‚
â”‚     â”‚                                 â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.2 æ¶ˆæ¯æ€»çº¿æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¶ˆæ¯æ€»çº¿æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   1. è¿æ¥å»ºç«‹ (TCP + mTLS æ¡æ‰‹)                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Client â”€â”€â”€â”€TCPâ”€â”€â”€â”€â–º Server                                 â”‚   â”‚
â”‚   â”‚                       â”‚                                     â”‚   â”‚
â”‚   â”‚                       â–¼                                     â”‚   â”‚
â”‚   â”‚               TLS Handshake (mTLS)                          â”‚   â”‚
â”‚   â”‚                       â”‚                                     â”‚   â”‚
â”‚   â”‚                       â–¼                                     â”‚   â”‚
â”‚   â”‚               Handshake Payload (version, client_name)      â”‚   â”‚
â”‚   â”‚                       â”‚                                     â”‚   â”‚
â”‚   â”‚                       â–¼                                     â”‚   â”‚
â”‚   â”‚           èº«ä»½éªŒè¯ + åè®®ç‰ˆæœ¬æ£€æŸ¥                            â”‚   â”‚
â”‚   â”‚                       â”‚                                     â”‚   â”‚
â”‚   â”‚                       â–¼                                     â”‚   â”‚
â”‚   â”‚              æ³¨å†Œåˆ° ConnectedClients                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚   2. æ¶ˆæ¯å‘é€/æ¥æ”¶                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Client â”€â”€RequestCommandâ”€â”€â–º MessageBus                      â”‚   â”‚
â”‚   â”‚                                     â”‚                       â”‚   â”‚
â”‚   â”‚                                     â–¼                       â”‚   â”‚
â”‚   â”‚                          MessageHandler (å¤„ç†æ¶ˆæ¯)           â”‚   â”‚
â”‚   â”‚                                     â”‚                       â”‚   â”‚
â”‚   â”‚                          broadcast_tx.send(response)         â”‚   â”‚
â”‚   â”‚                                     â”‚                       â”‚   â”‚
â”‚   â”‚               â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚   â”‚
â”‚   â”‚                 Response (correlation_id åŒ¹é…)               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚   3. å¹¿æ’­é€šçŸ¥                                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Server  â”€â”€Notificationâ”€â”€â–º MessageBus                       â”‚   â”‚
â”‚   â”‚                                    â”‚                        â”‚   â”‚
â”‚   â”‚                                    â–¼                        â”‚   â”‚
â”‚   â”‚                          broadcast_rx éå†                   â”‚   â”‚
â”‚   â”‚                                    â”‚                        â”‚   â”‚
â”‚   â”‚               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º     â”‚   â”‚
â”‚   â”‚                 å†™å…¥æ¯ä¸ª ConnectedClient                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ ¸å¿ƒæ¨¡å—ä¾èµ–å…³ç³»

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  edge-server    â”‚
                        â”‚    (ä¸»å…¥å£)     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                      â”‚                      â”‚
          â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ServerState   â”‚   â”‚    MessageBus   â”‚   â”‚  Config/Routes  â”‚
â”‚   (å…¨å±€çŠ¶æ€)    â”‚   â”‚   (æ¶ˆæ¯æ€»çº¿)    â”‚   â”‚   (HTTP è·¯ç”±)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                      â”‚
         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
         â”‚         â”‚                       â”‚          â”‚
         â–¼         â–¼                       â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CertService   â”‚   â”‚  MessageHandler â”‚   â”‚  Auth/JWT       â”‚
â”‚   (è¯ä¹¦ç®¡ç†)    â”‚   â”‚  (æ¶ˆæ¯å¤„ç†)     â”‚   â”‚  (è®¤è¯)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                      â”‚
         â”‚                     â”‚                      â”‚
         â–¼                     â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ crab-cert       â”‚   â”‚  DbService      â”‚   â”‚  SurrealDB      â”‚
â”‚ (PKI/åŠ å¯†)      â”‚   â”‚  (æ•°æ®åº“)       â”‚   â”‚  (å­˜å‚¨)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
         â”‚                     â”‚
         â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ x509-parser     â”‚   â”‚  AuditLogger    â”‚
â”‚ rustls          â”‚   â”‚  (å®¡è®¡æ—¥å¿—)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ç»„ä»¶è¯¦ç»†åˆ†æ

### 3.1 MessageBus æ¨¡å—

#### 3.1.1 å½“å‰å®ç°

**æ–‡ä»¶**: `edge-server/src/message/mod.rs`

| ç»„ä»¶ | è¡Œæ•° | èŒè´£ |
|------|------|------|
| `Transport Trait` | ~50 | ä¼ è¾“å±‚æŠ½è±¡ (TCP/TLS/Memory) |
| `TcpTransport` | ~80 | TCP ä¼ è¾“å®ç° |
| `TlsTransport` | ~60 | TLS/mTLS ä¼ è¾“å®ç° |
| `MemoryTransport` | ~60 | è¿›ç¨‹å†…ä¼ è¾“ |
| `MessageBus` | ~400 | æ ¸å¿ƒæ¶ˆæ¯æ€»çº¿ |

#### 3.1.2 æ¶ˆæ¯åè®® (äºŒè¿›åˆ¶æ ¼å¼)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¶ˆæ¯æ ¼å¼ (äºŒè¿›åˆ¶)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  0         1         2         3         4         N                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ Type(1) â”‚         Request UUID (16 bytes)        â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚              Correlation UUID (16 bytes)          â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚              Payload Length (4 bytes, LE)         â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚                   Payload (JSON)                   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚                                                                     â”‚
â”‚  EventType ç¼–ç :                                                     â”‚
â”‚  - Handshake        = 0                                             â”‚
â”‚  - Notification     = 1                                             â”‚
â”‚  - ServerCommand    = 2                                             â”‚
â”‚  - RequestCommand   = 3                                             â”‚
â”‚  - Sync             = 4                                             â”‚
â”‚  - Response         = 5                                             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.1.3 ä¼˜åŠ¿ä¸ä¸è¶³

| æ–¹é¢ | è¯„ä»· |
|------|------|
| **æ€§èƒ½** | â­â­â­â­ å¼‚æ­¥å¤„ç†ã€å°‘æ‹·è´ï¼ˆbroadcast ä»ä¼š clone BusMessageï¼‰ |
| **å¯æ‰©å±•æ€§** | â­â­â­â­ Transport Trait æ˜“æ‰©å±• |
| **å®‰å…¨æ€§** | â­â­â­â­â­ mTLS å¼ºåˆ¶ã€TLS è¯ä¹¦éªŒè¯ |
| **æŒä¹…åŒ–** | â­â­ ç¼ºå¤±ï¼Œæ— æ¶ˆæ¯æŒä¹…åŒ– |
| **å¯é æ€§** | â­â­ æ—  WALã€æ— æ¶ˆæ¯ç¡®è®¤ |
| **å¯è§‚æµ‹æ€§** | â­â­â­ æ—¥å¿—å®Œå–„ï¼Œç¼ºæŒ‡æ ‡ç›‘æ§ |

### 3.2 Certificate æ¨¡å—

#### 3.2.1 è¯ä¹¦å±‚æ¬¡ç»“æ„

```
crab-cert/src/ca.rs
â”‚
â”œâ”€â”€ CertificateAuthority (è¯ä¹¦é¢å‘æœºæ„)
â”‚   â”œâ”€â”€ new_root()          // åˆ›å»ºæ ¹ CA
â”‚   â”œâ”€â”€ new_intermediate()  // åˆ›å»ºä¸­é—´ CA
â”‚   â”œâ”€â”€ issue_cert()        // ç­¾å‘å®ä½“è¯ä¹¦
â”‚   â””â”€â”€ load()/save()       // æŒä¹…åŒ–
â”‚
â”œâ”€â”€ å¯†é’¥ç±»å‹
â”‚   â”œâ”€â”€ P256 (ECDSA)
â”‚   â”œâ”€â”€ Rsa2048
â”‚   â””â”€â”€ Rsa4096
â”‚
â””â”€â”€ è¯ä¹¦æ‰©å±• (profile.rs)
    â”œâ”€â”€ OID_TENANT_ID (1.3.6.1.4.1.99999.1)
    â”œâ”€â”€ OID_DEVICE_ID (1.3.6.1.4.1.99999.2)
    â””â”€â”€ OID_CLIENT_NAME (1.3.6.1.4.1.99999.5)
```

#### 3.2.2 mTLS æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        mTLS æ¡æ‰‹æµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   Client                              Server                        â”‚
â”‚     â”‚                                   â”‚                            â”‚
â”‚     â”‚  1. TCP Connect                   â”‚                            â”‚
â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                          â”‚
â”‚     â”‚                                   â”‚                            â”‚
â”‚     â”‚                      2. TLS Server Hello                      â”‚
â”‚     â”‚                      + Server Certificate                      â”‚
â”‚     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚     â”‚                                   â”‚                            â”‚
â”‚     â”‚  3. Client Certificate            â”‚                            â”‚
â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                          â”‚
â”‚     â”‚     (åŒ…å« device_id æ‰©å±•)          â”‚                            â”‚
â”‚     â”‚                                   â”‚                            â”‚
â”‚     â”‚                      4. TLS Handshake Complete                â”‚
â”‚     â”‚                                   â”‚                            â”‚
â”‚     â”‚  5. Application Data              â”‚                            â”‚
â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                          â”‚
â”‚     â”‚     Handshake Payload             â”‚                            â”‚
â”‚     â”‚     (version, client_name)        â”‚                            â”‚
â”‚     â”‚                                   â”‚                            â”‚
â”‚     â”‚                      6. éªŒè¯ client_name == è¯ä¹¦ CN            â”‚
â”‚     â”‚                      7. éªŒè¯ device_id == æœ¬æœºç¡¬ä»¶ ID          â”‚
â”‚     â”‚                                   â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ•°æ®åº“æ¨¡å—

#### 3.3.1 SurrealDB ä½¿ç”¨

**æ–‡ä»¶**: `edge-server/src/db/mod.rs`

```rust
// å½“å‰ä½¿ç”¨æ–¹å¼
let db = Surreal::new::<RocksDb>(path).await?;

// å®šä¹‰å‘½åç©ºé—´å’Œæ•°æ®åº“
db.use_ns("edge_server").use_db("edge_server").await?;

// è¿ç§»
MigrationRunner::new(&db).load_files(&MIGRATIONS_DIR).up().await?;
```

#### 3.3.2 æ•°æ®æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®åº“æ¨¡å‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  employee (å‘˜å·¥)                                                    â”‚
â”‚  â”œâ”€â”€ id: string (record ID)                                         â”‚
â”‚  â”œâ”€â”€ username: string                                               â”‚
â”‚  â”œâ”€â”€ password_hash: string                                          â”‚
â”‚  â”œâ”€â”€ role: record                                                   â”‚
â”‚  â””â”€â”€ is_active: bool                                                â”‚
â”‚                                                                     â”‚
â”‚  role (è§’è‰²)                                                        â”‚
â”‚  â”œâ”€â”€ id: string                                                     â”‚
â”‚  â”œâ”€â”€ role_name: string                                              â”‚
â”‚  â”œâ”€â”€ permissions: array<string>                                     â”‚
â”‚  â””â”€â”€ is_active: bool                                                â”‚
â”‚                                                                     â”‚
â”‚  audit_log (å®¡è®¡æ—¥å¿—) - å¯é€‰å¯ç”¨                                     â”‚
â”‚  â”œâ”€â”€ action: enum                                                   â”‚
â”‚  â”œâ”€â”€ resource: string                                               â”‚
â”‚  â”œâ”€â”€ user_id: string                                                â”‚
â”‚  â””â”€â”€ created_at: datetime                                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 è®¤è¯æ¨¡å—

#### 3.4.1 JWT æµç¨‹

**æ–‡ä»¶**: `edge-server/src/server/auth/jwt.rs`

| ç‰¹æ€§ | å½“å‰å®ç° |
|------|---------|
| ç®—æ³• | HS256 |
| è¿‡æœŸæ—¶é—´ | 24 å°æ—¶ (å¯é…ç½®) |
| å¯†é’¥æ¥æº | ç¯å¢ƒå˜é‡ JWT_SECRET |
| æƒé™æ ¼å¼ | é€—å·åˆ†éš”å­—ç¬¦ä¸² |
| åˆ·æ–°æœºåˆ¶ | æ—  (é‡æ–°ç™»å½•) |

#### 3.4.2 æƒé™ç³»ç»Ÿ

```rust
// CurrentUser ç»“æ„
pub struct CurrentUser {
    pub id: String,
    pub username: String,
    pub role: String,
    pub permissions: Vec<String>,
}

// æƒé™æ£€æŸ¥
impl CurrentUser {
    pub fn has_permission(&self, permission: &str) -> bool {
        if self.is_admin() { return true; }
        if self.permissions.contains(&"all".to_string()) { return true; }
        
        // é€šé…ç¬¦æ”¯æŒ: "products:*" åŒ¹é… "products:create"
        self.permissions.iter().any(|p| {
            if p == permission { return true; }
            if let Some(prefix) = p.strip_suffix(":*") {
                permission.starts_with(&format!("{}:", prefix))
            } else { false }
        })
    }
}
```

---

## 4. é£é™©è¯„ä¼°

### 4.1 å®‰å…¨é£é™©

| é£é™© | ä¸¥é‡æ€§ | ä½ç½® | æè¿° | ç¼“è§£æªæ–½ |
|------|--------|------|------|----------|
| **R-01 å¼± JWT å¯†é’¥** | ğŸ”´ é«˜ | `edge-server/src/server/auth/jwt.rs:26-38` | debug æ¨¡å¼å…è®¸é»˜è®¤å¯†é’¥ï¼ˆrelease ä¼š panicï¼‰ | ç”Ÿäº§å¼ºåˆ¶é…ç½® + CI æ ¡éªŒ |
| **R-02 è·³è¿‡ä¸»æœºåéªŒè¯** | ğŸ”´ é«˜ | `crab-client/src/http.rs:40-47` | `dangerous()` è‡ªå®šä¹‰ verifierï¼Œå¼±åŒ– HTTPS çš„ä¸»æœºåè¯­ä¹‰ | é™å®šä»… mTLS åœºæ™¯ + æ˜ç¡®é…ç½®å¼€å…³ |
| **R-04 ç¡¬ä»¶ ID å¯ä¼ªé€ ** | ğŸŸ¡ ä¸­ | `machine.rs` | äº‘ç¯å¢ƒå¤šå®ä¾‹å¯èƒ½é‡å¤ | å¢åŠ å®ä¾‹å”¯ä¸€æ ‡è¯† |
| **R-05 æ•æ„Ÿæ—¥å¿—æ³„éœ²** | ğŸŸ¡ ä¸­ | å¤šå¤„ `tracing!` | å¯†ç /JWT å¯èƒ½å†™å…¥æ—¥å¿— | å®ç°æ—¥å¿—è„±æ• |
| **R-06 æ—  Rate Limiting** | ğŸŸ¡ ä¸­ | `routes/` | æš´åŠ›ç ´è§£é£é™© | æ·»åŠ é™æµä¸­é—´ä»¶ |

### 4.2 å¯é æ€§é£é™©

| é£é™© | ä¸¥é‡æ€§ | ä½ç½® | æè¿° | ç¼“è§£æªæ–½ |
|------|--------|------|------|----------|
| **R-07 æ¶ˆæ¯ä¸¢å¤±** | ğŸ”´ é«˜ | `message/mod.rs` | æ— æŒä¹…åŒ–ï¼Œå´©æºƒä¸¢å¤± | å¼•å…¥ redb æŒä¹…åŒ– |
| **R-08 æ­»è¿æ¥å ç”¨** | ğŸ”´ é«˜ | `message/mod.rs:519` | æ— å¿ƒè·³æ£€æµ‹ | å®ç° PING/PONG |
| **R-09 Panic å¯¼è‡´å´©æºƒ** | ğŸ”´ é«˜ | `activation.rs:72` | è‡ªæ£€å¤±è´¥ç›´æ¥ panic | æ”¹ç”¨ Result å¤„ç† |
| **R-10 è¯ä¹¦è¿‡æœŸæ— æ£€æŸ¥** | ğŸŸ¡ ä¸­ | `credential.rs` | è¿‡æœŸè¯ä¹¦ä»å¯ç”¨ | æ·»åŠ æœ‰æ•ˆæœŸæ£€æŸ¥ |

### 4.3 æ¶æ„é£é™©

| é£é™© | ä¸¥é‡æ€§ | æè¿° | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| **R-11 é”™è¯¯å¤„ç†ä¸ä¸€è‡´** | ğŸŸ¡ ä¸­ | `AppError` ä¸åŸå§‹é”™è¯¯æ··ç”¨ | ç»Ÿä¸€é”™è¯¯ç±»å‹ |
| **R-12 é…ç½®åˆ†æ•£** | ğŸŸ¡ ä¸­ | å¤šå¤„æ¥æº (env, .env, ä»£ç ) | ç»Ÿä¸€é…ç½®åŠ è½½ |
| **R-13 æµ‹è¯•è¦†ç›–ä¸è¶³** | ğŸ”´ é«˜ | é›†æˆæµ‹è¯•ã€å®‰å…¨æµ‹è¯•ç¼ºå¤± | æ·»åŠ  CI æµ‹è¯• |
| **R-14 å•ç‚¹æ•…éšœ** | ğŸŸ¡ ä¸­ | æ— é«˜å¯ç”¨æ¶æ„ | è€ƒè™‘é›†ç¾¤æ¨¡å¼ |

### 4.4 æ€§èƒ½é£é™©

| é£é™© | ä¸¥é‡æ€§ | æè¿° | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| **R-15 å¹¿æ’­é€šé“æº¢å‡º** | ğŸŸ¡ ä¸­ | å›ºå®š 1024 å®¹é‡ | åŠ¨æ€æ‰©å®¹æˆ–æŒä¹…åŒ– |
| **R-16 é˜»å¡å¼åˆ·ç›˜** | ğŸŸ¡ ä¸­ | æ•°æ®åº“åŒæ­¥å†™å…¥ | å¼‚æ­¥åˆ·ç›˜ |
| **R-17 æ— è¿æ¥æ± ** | ğŸŸ¡ ä½ | æ¯æ¬¡è¯·æ±‚æ–°å»º HTTP è¿æ¥ | å¤ç”¨è¿æ¥ |

---

## 5. ä¼˜åŒ–å»ºè®®

### 5.1 é«˜ä¼˜å…ˆçº§ä¼˜åŒ–

#### OPT-001: MessageBus æŒä¹…åŒ– (redb)

**æè¿°**: å¼•å…¥ redb å®ç°æ¶ˆæ¯æŒä¹…åŒ–ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±

**å½±å“èŒƒå›´**: `edge-server/src/message/`

**è¯¦ç»†è®¾è®¡**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MessageBus + redb æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  å†™å…¥è·¯å¾„:                                                           â”‚
â”‚  1. æ¶ˆæ¯ â”€â”€â–º WAL (redb) â”€â”€â–º broadcast â”€â”€â–º æ¶ˆè´¹è€…                    â”‚
â”‚                                                                     â”‚
â”‚  è¯»å–è·¯å¾„:                                                           â”‚
â”‚  1. å®æ—¶: broadcast_rx.recv()                                        â”‚
â”‚  2. é‡æ”¾: redb èŒƒå›´æŸ¥è¯¢                                              â”‚
â”‚                                                                     â”‚
â”‚  è¡¨ç»“æ„:                                                             â”‚
â”‚  - messages: SequenceNumber -> PersistedMessage                     â”‚
â”‚  - consumer_offsets: (Topic, ConsumerId) -> Offset                  â”‚
â”‚  - dead_letters: SequenceNumber -> DeadLetter                       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾èµ–**: `redb = "2.0"`

#### OPT-002: å¿ƒè·³æ£€æµ‹æœºåˆ¶

**æè¿°**: å®ç°å®¢æˆ·ç«¯å¿ƒè·³ï¼Œé˜²æ­¢æ­»è¿æ¥å ç”¨èµ„æº

**ä»£ç ç¤ºä¾‹**:

```rust
// åœ¨ Transport trait ä¸­æ·»åŠ 
#[async_trait]
pub trait Transport: Send + Sync {
    // ... ç°æœ‰æ–¹æ³•
    
    /// å‘é€å¿ƒè·³
    async fn ping(&self) -> Result<(), AppError>;
    
    /// æ£€æŸ¥è¿æ¥æ˜¯å¦æ´»è·ƒ
    fn is_alive(&self) -> bool;
}

// åœ¨ MessageHandler ä¸­å®šæœŸæ£€æŸ¥
async fn check_dead_connections(&self) {
    let now = Instant::now();
    for (client_id, transport) in &self.clients {
        if !transport.is_alive() {
            tracing::warn!("Removing dead client: {}", client_id);
            self.clients.remove(client_id);
        }
    }
}
```

#### OPT-003: ç»Ÿä¸€é”™è¯¯å¤„ç†

**æè¿°**: æ¶ˆé™¤ panicï¼Œæ”¹ä¸º Result ä¼ æ’­

**ä¿®å¤ä½ç½®**: `activation.rs:72`

```rust
// Before
if let Err(e) = cert_service.self_check().await {
    panic!("Boot self-check failed: {}", e);
}

// After
if let Err(e) = cert_service.self_check().await {
    return Err(AppError::internal(format!(
        "Boot self-check failed: {}. Server requires manual intervention.",
        e
    )));
}
```

### 5.2 ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–

#### OPT-004: æ—¥å¿—è„±æ•

**æè¿°**: æ•æ„Ÿä¿¡æ¯ä¸å†™å…¥æ—¥å¿—

```rust
// å®ç°è„±æ•ä¸­é—´ä»¶
fn sanitize_value(key: &str, value: &str) -> String {
    const SENSITIVE_KEYS: &[&str] = &[
        "password",
        "token",
        "secret",
        "private_key",
        "jwt_secret",
    ];
    
    if SENSITIVE_KEYS.iter().any(|k| key.to_lowercase().contains(k)) {
        "[REDACTED]".to_string()
    } else {
        value.to_string()
    }
}
```

#### OPT-005: è¯ä¹¦æœ‰æ•ˆæœŸæ£€æŸ¥

**æè¿°**: åœ¨è‡ªæ£€æ—¶éªŒè¯è¯ä¹¦æœªè¿‡æœŸ

```rust
pub async fn self_check(&self) -> Result<(), AppError> {
    // ... ç°æœ‰æ£€æŸ¥
    
    // æ–°å¢: è¯ä¹¦è¿‡æœŸæ£€æŸ¥
    let metadata = CertMetadata::from_pem(&cert_pem)?;
    if metadata.not_after < time::OffsetDateTime::now_utc() {
        return Err(AppError::validation(format!(
            "Certificate expired at {}. Please renew.",
            metadata.not_after
        )));
    }
    
    Ok(())
}
```

#### OPT-006: é™æµä¸­é—´ä»¶

**æè¿°**: é˜²æ­¢æš´åŠ›ç ´è§£å’Œ DoS æ”»å‡»

```rust
// ä½¿ç”¨ tower::limit::RateLimitLayer
use tower::limit::RateLimitLayer;

let rate_limit = RateLimitLayer::new(100, std::time::Duration::from_secs(60)); // 100 req/min

Router::new()
    .layer(rate_limit)
    // ...
```

### 5.3 ä½ä¼˜å…ˆçº§ä¼˜åŒ–

#### OPT-007: é…ç½®éªŒè¯

**æè¿°**: å¯åŠ¨æ—¶éªŒè¯é…ç½®åˆæ³•æ€§

#### OPT-008: æŒ‡æ ‡ç›‘æ§

**æè¿°**: æ·»åŠ  Prometheus æŒ‡æ ‡

#### OPT-009: åˆ†å¸ƒå¼è¿½è¸ª

**æè¿°**: å®ç° trace_id ä¼ æ’­

---

## 6. è¡ŒåŠ¨ä»»åŠ¡æ¸…å•

### 6.1 P0 - ç«‹å³æ‰§è¡Œ

| ID | ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥æ—¶ | è´Ÿè´£äºº | çŠ¶æ€ |
|----|------|--------|----------|--------|------|
| **T-001** | ä¿®å¤è®¤è¯é”™è¯¯æ¶ˆæ¯æ³„éœ²é—®é¢˜ | P0 | 2h | - | â³ å¾…å¤„ç† |
| **T-002** | ç§»é™¤ panic æ”¹ç”¨é”™è¯¯ä¼ æ’­ | P0 | 4h | - | â³ å¾…å¤„ç† |
| **T-003** | å®ç°æ­»ä¿¡é˜Ÿåˆ— (DLQ) | P0 | 6h | - | â³ å¾…å¤„ç† |
| **T-004** | æ·»åŠ  JWT_SECRET ç¯å¢ƒå˜é‡æ£€æŸ¥ | P0 | 1h | - | â³ å¾…å¤„ç† |

### 6.2 P1 - æœ¬å‘¨å®Œæˆ

| ID | ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥æ—¶ | è´Ÿè´£äºº | çŠ¶æ€ |
|----|------|--------|----------|--------|------|
| **T-005** | å¼•å…¥ redb ä¾èµ– | P1 | 1h | - | â³ å¾…å¤„ç† |
| **T-006** | å®ç° MessageStore ç»“æ„ | P1 | 8h | - | â³ å¾…å¤„ç† |
| **T-007** | å®ç° WAL (Write-Ahead Log) | P1 | 12h | - | â³ å¾…å¤„ç† |
| **T-008** | å®ç°æ¶ˆè´¹è€…åç§»é‡ç®¡ç† | P1 | 8h | - | â³ å¾…å¤„ç† |
| **T-009** | å®ç°å¿ƒè·³æ£€æµ‹æœºåˆ¶ | P1 | 6h | - | â³ å¾…å¤„ç† |
| **T-010** | æ·»åŠ è¯ä¹¦æœ‰æ•ˆæœŸæ£€æŸ¥ | P1 | 4h | - | â³ å¾…å¤„ç† |

### 6.3 P2 - è¿‘æœŸè§„åˆ’

| ID | ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥æ—¶ | è´Ÿè´£äºº | çŠ¶æ€ |
|----|------|--------|----------|--------|------|
| **T-011** | å®ç°æ—¥å¿—è„±æ• | P2 | 4h | - | â³ å¾…å¤„ç† |
| **T-012** | æ·»åŠ é™æµä¸­é—´ä»¶ | P2 | 6h | - | â³ å¾…å¤„ç† |
| **T-013** | å®Œå–„é…ç½®éªŒè¯ | P2 | 4h | - | â³ å¾…å¤„ç† |
| **T-014** | æ·»åŠ  Prometheus æŒ‡æ ‡ | P2 | 8h | - | â³ å¾…å¤„ç† |
| **T-015** | ç¼–å†™é›†æˆæµ‹è¯• | P2 | 16h | - | â³ å¾…å¤„ç† |

### 6.4 P3 - é•¿æœŸè§„åˆ’

| ID | ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥æ—¶ | è´Ÿè´£äºº | çŠ¶æ€ |
|----|------|--------|----------|--------|------|
| **T-016** | é«˜å¯ç”¨é›†ç¾¤æ”¯æŒ | P3 | 40h | - | â³ å¾…å¤„ç† |
| **T-017** | åŠ¨æ€é…ç½®æ›´æ–° | P3 | 24h | - | â³ å¾…å¤„ç† |
| **T-018** | æ¶ˆæ¯å‹ç¼©ä¼˜åŒ– | P3 | 12h | - | â³ å¾…å¤„ç† |
| **T-019** | WebSocket ä¼ è¾“æ”¯æŒ | P3 | 20h | - | â³ å¾…å¤„ç† |

---

## 7. è¿½è¸ªè¿›åº¦

### 7.1 è¿›åº¦æ¦‚è§ˆ

```
P0 ä»»åŠ¡: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  4/16 (25%)
P1 ä»»åŠ¡: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  6/16 (37.5%)
P2 ä»»åŠ¡: â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  1/5  (20%)
P3 ä»»åŠ¡: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  0/4  (0%)
```

### 7.2 æœ¬å‘¨ç›®æ ‡

- [ ] å®Œæˆ T-001 ~ T-004 (P0 ä¿®å¤)
- [ ] å®Œæˆ redb é›†æˆè®¾è®¡è¯„å®¡
- [ ] ç¡®å®šæ¶ˆæ¯æŒä¹…åŒ– API è®¾è®¡

### 7.3 åç»­è·Ÿè¸ª

å»ºè®®æ¯å‘¨æ›´æ–°æ­¤æ–‡æ¡£:

```markdown
## æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ | æ›´æ–°äºº |
|------|------|----------|--------|
| 2026-01-16 | v1.0 | åˆå§‹ç‰ˆæœ¬ | - |
| 2026-01-23 | v1.1 | æ›´æ–° T-001~T-004 çŠ¶æ€ | - |
```

---

## é™„å½•

### A. å…³é”®å…¥å£ä¸è¿è¡Œä¸»é“¾è·¯

- Edge Server ä¸»å…¥å£ï¼š[main.rs](file:///Users/xzy/workspace/crab/edge-server/src/main.rs#L1-L28)
- Server ç”Ÿå‘½å‘¨æœŸï¼ˆæ¿€æ´»å¾ªç¯ + å¯åŠ¨ TCP Bus + å¯åŠ¨ HTTPSï¼‰ï¼š[server/mod.rs](file:///Users/xzy/workspace/crab/edge-server/src/server/mod.rs#L16-L115)
- å…¨å±€çŠ¶æ€èšåˆï¼ˆDB + Activation + Cert + MessageBus + HTTPSï¼‰ï¼š[state.rs](file:///Users/xzy/workspace/crab/edge-server/src/server/state.rs#L10-L152)

ä¸»é“¾è·¯å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š

1) åˆå§‹åŒ–è¿è¡Œç¯å¢ƒï¼ˆwork_dir/logs/certsï¼‰â†’ 2) åˆå§‹åŒ– DB ä¸æœåŠ¡ â†’ 3) å¯åŠ¨æ¶ˆæ¯å¤„ç†åå°ä»»åŠ¡ â†’ 4) ç­‰å¾…æ¿€æ´»ï¼ˆCredential.json å­˜åœ¨ï¼‰â†’ 5) è¯ä¹¦è‡ªæ£€ï¼ˆé“¾è·¯ + ç¡¬ä»¶ç»‘å®šï¼‰â†’ 6) åŠ è½½ mTLS é…ç½®å¹¶å¯åŠ¨ TCP æ¶ˆæ¯æ€»çº¿ + HTTPSã€‚

### B. æ¶ˆæ¯åè®®ä¸å®ç°å·®å¼‚ç‚¹

- åè®®ç±»å‹ä¸ Payload å®šä¹‰ä½äº sharedï¼š[message/mod.rs](file:///Users/xzy/workspace/crab/shared/src/message/mod.rs#L1-L285)ã€[payload.rs](file:///Users/xzy/workspace/crab/shared/src/message/payload.rs#L1-L169)
- Edge Server çš„ TCP wire æ ¼å¼ä»…ç¼–ç  `event_type + request_id + correlation_id + payload`ï¼ˆä¸ç¼–ç  source/targetï¼‰ï¼š[message/mod.rs](file:///Users/xzy/workspace/crab/edge-server/src/message/mod.rs#L71-L159)
- å½±å“ï¼š
  - `source` ç”±æœåŠ¡ç«¯åœ¨æ¥æ”¶åæ³¨å…¥ï¼ˆç”¨äºå› Ackï¼‰ï¼š[message/mod.rs](file:///Users/xzy/workspace/crab/edge-server/src/message/mod.rs#L752-L756)
  - `target` ç”¨äºæœåŠ¡ç«¯ä¾§çš„ Unicast è¿‡æ»¤ï¼Œä¸éœ€è¦è·¨ wire ä¼ è¾“ï¼š[message/mod.rs](file:///Users/xzy/workspace/crab/edge-server/src/message/mod.rs#L717-L723)

### C. è¯ä¹¦ä½“ç³»ä¸ç¡¬ä»¶ç»‘å®šè½ç‚¹

- ç¡¬ä»¶ IDï¼šcrab-cert ç”Ÿæˆä¸å“ˆå¸Œèšåˆï¼š[machine.rs](file:///Users/xzy/workspace/crab/crab-cert/src/machine.rs#L17-L53)
- è¯ä¹¦è‡ªå®šä¹‰æ‰©å±•ï¼ˆtenant_id/device_id/client_name OIDï¼‰ï¼š[profile.rs](file:///Users/xzy/workspace/crab/crab-cert/src/profile.rs#L15-L245)
- è¯ä¹¦å…ƒæ•°æ®è§£æï¼ˆä»æ‰©å±•è¯»å– + æŒ‡çº¹ï¼‰ï¼š[metadata.rs](file:///Users/xzy/workspace/crab/crab-cert/src/metadata.rs#L17-L96)
- Edge Server è¯ä¹¦è‡ªæ£€ï¼ˆé“¾æ ¡éªŒ + è§£æ metadata + æ ¡éªŒ device_idï¼‰ï¼š[credential.rs](file:///Users/xzy/workspace/crab/edge-server/src/server/services/credential.rs#L12-L42)

### D. å·²å®ç°ä¸â€œåä¹‰å®ç°â€åŒºåˆ†

- MessageHandler çš„â€œACID/æ­»ä¿¡é˜Ÿåˆ—/å¹‚ç­‰â€ç­‰ç‰¹æ€§ç›®å‰ä¸»è¦ä½“ç°åœ¨ç»“æ„ä¸æ—¥å¿—ï¼ŒDLQ å°šæœªè½åœ°ï¼š
  - å¤„ç†å™¨ä¸»å¾ªç¯ï¼š[handler.rs](file:///Users/xzy/workspace/crab/edge-server/src/message/handler.rs#L79-L114)
  - DLQ TODOï¼š[handler.rs](file:///Users/xzy/workspace/crab/edge-server/src/message/handler.rs#L264-L280)
- å½“å‰ RequestCommand å·²å®ç°çš„åŠ¨ä½œè¾ƒå°‘ï¼ˆping/echo/statusï¼‰ï¼š[processor.rs](file:///Users/xzy/workspace/crab/edge-server/src/message/processor.rs#L151-L194)

### E. å»ºè®®çš„æœ€å°å¯è¡Œæ”¹é€ åˆ‡å…¥ç‚¹ï¼ˆä¸æ”¹å˜æ€»ä½“æ¶æ„ï¼‰

1) æŠŠâ€œè‡ªæ£€å¤±è´¥ panicâ€æ”¹ä¸ºå¯æ¢å¤é”™è¯¯è·¯å¾„ï¼Œé¿å…ä¸å¯æ§å´©æºƒï¼ˆå¯¹åº” R-09ï¼‰ï¼š[activation.rs](file:///Users/xzy/workspace/crab/edge-server/src/server/services/activation.rs#L70-L76)
2) ä¸ºæ¶ˆæ¯æ€»çº¿è¡¥é½â€œå¯è§‚æµ‹æ€§ + backpressureâ€æŒ‡æ ‡ï¼šbroadcast lagã€è¿æ¥æ•°ã€å¤„ç†è€—æ—¶åˆ†å¸ƒã€‚
3) æ˜ç¡® SkipHostnameVerifier çš„è¾¹ç•Œï¼šä»…åœ¨â€œTenant CA ä½œä¸º LAN ä¿¡ä»»æ ¹â€çš„ mTLS åœºæ™¯å¯ç”¨ï¼Œå¹¶é€šè¿‡é…ç½®æ˜¾å¼æ‰“å¼€ã€‚

### A. å‚è€ƒæ–‡æ¡£

- [CLAUDE.md](../CLAUDE.md) - é¡¹ç›®å¼€å‘æŒ‡å—
- [SurrealDB æ–‡æ¡£](https://surrealdb.com/docs)
- [redb æ–‡æ¡£](https://github.com/cberner/redb)
- [Rust Tokio](https://tokio.rs)

### B. ä»£ç æŒ‡æ ‡

```
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ–‡ä»¶ç»Ÿè®¡ (ä¼°ç®—)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
edge-server/       ~8000 è¡Œ
crab-client/       ~2000 è¡Œ
crab-cert/         ~3000 è¡Œ
shared/            ~1500 è¡Œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡               ~14500 è¡Œ Rust ä»£ç 
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### C. ä¾èµ–æ¸…å•

```
# Cargo.toml å…³é”®ä¾èµ–
axum = "0.7"           # Web æ¡†æ¶
tokio = "1"            # å¼‚æ­¥è¿è¡Œæ—¶
surrealdb = "2"        # åµŒå…¥å¼æ•°æ®åº“
rustls = "0.21"        # TLS å®ç°
jsonwebtoken = "9"     # JWT å¤„ç†
argon2 = "0.5"         # å¯†ç å“ˆå¸Œ
rcgen = "0.11"         # è¯ä¹¦ç”Ÿæˆ
```

---

> **æ³¨æ„**: æœ¬æ–‡æ¡£åº”æ ¹æ®é¡¹ç›®è¿›å±•å®šæœŸæ›´æ–°ï¼Œå»ºè®®æ¯å‘¨åŒæ­¥è¿›åº¦ã€‚
