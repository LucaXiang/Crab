# Crab SaaS 餐饮管理平台 - 全面评估与建设计划

> 评估日期: 2026-02-04
> 目标市场: 西班牙
> 商业模式: 固定月费 SaaS
> 目标客户: 小型单店 + 中型连锁 (1-20 家门店)
> 部署模式: 边缘运行 + 云端同步

---

## 一、项目总体评估

### 1.1 项目概况

| 维度 | 数据 |
|------|------|
| **代码规模** | ~134,000 行 (Rust + TypeScript) |
| **Commit 数** | 485 个 |
| **Workspace 成员** | 7 个 Rust Crate + 1 个 Tauri 前端 |
| **开发阶段** | Alpha → Beta 过渡期 |

### 1.2 总体评分

| 维度 | 评分 | 状态 |
|------|------|------|
| **技术架构** | ⭐⭐⭐⭐⭐ | 优秀 — 事件溯源+CQRS 标准实现 |
| **代码质量** | ⭐⭐⭐⭐ | 良好 — 少量重复，整体清晰 |
| **POS 功能** | ⭐⭐⭐⭐ | 84% — 核心完整，缺库存/会员 |
| **安全防御** | ⭐⭐⭐⭐ | 良好 — mTLS+RBAC+审计 |
| **SaaS 能力** | ⭐⭐ | 35% — 基础多租户，缺计费/门户 |
| **西班牙合规** | ⭐⭐ | 35% — 缺 Verifactu/本地化 |
| **测试覆盖** | ⭐⭐⭐ | 中等 — 单元测试全，缺集成测试 |

---

## 二、技术架构分析

### 2.1 Workspace 结构

```
crab/
├── shared/          # 共享类型、协议、错误系统 (6,081 行)
├── edge-server/     # 边缘服务器 (56,306 行)
├── crab-client/     # 统一客户端库 (4,327 行)
├── crab-cert/       # PKI/证书管理 (2,109 行)
├── crab-auth/       # 认证服务器 (1,022 行)
├── crab-printer/    # ESC/POS 打印库 (1,299 行)
└── red_coral/       # Tauri POS 前端 (52,485 行 TS + 10,614 行 Rust)
```

### 2.2 核心架构优势

| 设计模式 | 实现质量 | 说明 |
|----------|----------|------|
| **事件溯源** | ⭐⭐⭐⭐⭐ | 22 命令 + 26 事件，CommandHandler/EventApplier 分离 |
| **CQRS** | ⭐⭐⭐⭐⭐ | 写端命令完整，读端快照优化 |
| **离线优先** | ⭐⭐⭐⭐⭐ | redb 本地存储，完全离线可运行 |
| **mTLS 安全** | ⭐⭐⭐⭐⭐ | 三层 CA 层级，TLS 1.3 + aws-lc-rs |
| **多租户** | ⭐⭐⭐⭐ | tenant_id 贯穿，数据命名空间隔离 |

### 2.3 技术栈

**后端 (Rust)**:
- 异步: Tokio
- Web: Axum 0.8
- 数据库: SurrealDB 2.4 (主) + redb 3.0 (事件存储)
- 安全: Rustls 0.23, Argon2, JWT

**前端 (TypeScript)**:
- 框架: React 19 + Tauri 2.9
- 状态: Zustand 5.0
- 样式: Tailwind CSS 4.1
- 精度: decimal.js (金额计算)

### 2.4 已识别的技术风险

| 风险等级 | 问题 | 位置 | 建议 |
|---------|------|------|------|
| **HIGH** | broadcast lag 可能导致事件丢失 | event_router.rs | 监控 lag 事件 |
| **MEDIUM** | 快照每事件都保存 | storage.rs | 批处理优化 |
| **MEDIUM** | 代码重复 (money.rs 2455 行) | orders/ | 拆分重构 |
| **LOW** | 1626 处 unwrap/panic | 全项目 | 逐步替换 |

---

## 三、POS 功能完整性

### 3.1 已完成功能 ✅

| 模块 | 完成度 | 核心功能 |
|------|--------|----------|
| **订单管理** | 95% | 创建/修改/取消/完成、分账、合并、转台 |
| **商品管理** | 90% | 分类、属性、规格、标签、价格规则 |
| **餐桌管理** | 95% | 区域、餐桌、容量、占用状态 |
| **支付** | 80% | 现金、刷卡、3种分账模式 |
| **打印** | 95% | 收据、厨房单、标签打印 |
| **班次** | 90% | 开班、关班、现金差异、自动提醒 |
| **权限** | 95% | RBAC 12 权限、敏感操作保护 |
| **日报** | 85% | 营业额、订单数、税率统计 |
| **审计** | 95% | 全操作记录、哈希链防篡改 |

### 3.2 缺失功能

| 功能 | 优先级 | 工作量 | 说明 |
|------|--------|--------|------|
| **库存管理** | P0 | 120-160h | 库存扣减、预警、进货单 |
| **会员系统** | P1 | 80-120h | 积分、等级、消费记录 |
| **预订管理** | P2 | 40-60h | 预订时间、餐桌、提醒 |
| **外卖集成** | P2 | 60-80h | Glovo/Uber Eats 对接 |
| **员工排班** | P2 | 100-150h | 排班表、打卡、工时 |
| **KDS 厨显** | P2 | 60-80h | 厨房订单显示屏 |

---

## 四、西班牙市场合规评估

### 4.1 Verifactu 法规要求 (2027年强制)

西班牙 HAC/1177/2024 法规要求所有 POS 系统符合 Verifactu 标准：

| 要求 | 当前状态 | 差距 |
|------|----------|------|
| **哈希链发票 (huella)** | ⚠️ 审计日志有 | 发票本身无哈希链 |
| **QR 码验证** | ❌ 缺失 | 必须实现 |
| **XML UTF-8 格式** | ❌ 缺失 | 必须实现 |
| **实时上报 AEAT** | ❌ 缺失 | 必须实现 |
| **软件供应商声明** | — | 需签署合规声明 |

**罚款**: 企业最高 €50,000，软件供应商最高 €150,000

**生效时间**:
- 2027年1月: 法人企业
- 2027年7月: 个体户/自由职业者

### 4.2 已具备的合规基础

| 方面 | 状态 | 说明 |
|------|------|------|
| **税率系统** | ✅ 95% | 支持西班牙 IVA 0%/4%/10%/21% |
| **收据格式** | ✅ 90% | FACTURA SIMPLIFICADA 格式 |
| **NIF 字段** | ✅ 100% | 门店信息含税号 |
| **货币格式** | ✅ 100% | 欧元、es-ES locale |
| **审计哈希链** | ✅ 可复用 | 现有机制可扩展到发票 |

### 4.3 缺失的合规项

| 项目 | 优先级 | 工作量 | 说明 |
|------|--------|--------|------|
| **Verifactu 发票系统** | P0 | 160-240h | QR码+哈希链+XML+AEAT API |
| **西班牙语翻译** | P0 | 40-60h | 2000+ UI 文本键 |
| **GDPR 数据 API** | P1 | 24-40h | 数据导出/删除端点 |

---

## 五、SaaS 平台缺口分析

### 5.1 当前 vs 目标架构

```
当前架构:
┌─────────────┐     ┌─────────────┐
│  crab-auth  │     │ edge-server │ × N
│ (激活/订阅) │◄────│ (本地 POS)  │
└─────────────┘     └─────────────┘

目标架构:
┌─────────────────────────────────────────────────┐
│              SaaS 云端管理平台                   │
│  ┌──────────┐ ┌──────────┐ ┌──────────────────┐ │
│  │ 客户门户 │ │ 管理后台 │ │ 计费系统         │ │
│  │ (注册/  │ │ (租户/  │ │ (Stripe/订阅/   │ │
│  │  订阅)  │ │  监控)  │ │  发票)          │ │
│  └──────────┘ └──────────┘ └──────────────────┘ │
│  ┌──────────────────────────────────────────┐   │
│  │         数据同步 + 聚合报表               │   │
│  └──────────────────────────────────────────┘   │
└───────────────────────┬─────────────────────────┘
                        │ mTLS
┌───────────────────────▼─────────────────────────┐
│              edge-server × N                     │
│         (设备授权 + 数据同步)                    │
└─────────────────────────────────────────────────┘
```

### 5.2 SaaS 功能缺口

#### P0 — 无法收费/运营

| 模块 | 缺失功能 | 工作量 |
|------|----------|--------|
| **支付集成** | Stripe 订阅支付、Webhook | 40-60h |
| **客户门户** | 注册、登录、订阅管理、账单 | 80-120h |
| **订阅管理** | 套餐定义、试用期、续费/欠费 | 40-60h |
| **设备授权** | 设备数量限制、授权码管理 | 30-40h |

#### P1 — 无法规模化运营

| 模块 | 缺失功能 | 工作量 |
|------|----------|--------|
| **管理后台** | 租户列表、用量监控、客服工具 | 60-80h |
| **设备监控** | 在线状态、心跳检测、告警 | 40-60h |
| **云端同步** | 边缘→云端数据同步、聚合报表 | 80-120h |
| **OTA 更新** | 远程推送软件更新 | 40-60h |

#### P2 — 竞争力提升

| 模块 | 缺失功能 | 工作量 |
|------|----------|--------|
| **多店管理** | 连锁品牌、门店分组、权限继承 | 60-80h |
| **云端报表** | 多店聚合、对比分析 | 40-60h |
| **帮助系统** | 用户手册、FAQ、引导教程 | 20-40h |

### 5.3 固定月费计费设计

```
定价模型 (按设备/门店):
┌─────────────┬─────────────┬────────────────────────┐
│ 套餐        │ 月费        │ 包含                   │
├─────────────┼─────────────┼────────────────────────┤
│ 基础版      │ €X/月       │ 1 设备，基础 POS 功能  │
│ 专业版      │ €XX/月      │ 3 设备，完整功能       │
│ 企业版      │ €XXX/月     │ 无限设备，多店管理     │
└─────────────┴─────────────┴────────────────────────┘

计费流程:
注册 → 选择套餐 → Stripe 订阅 → 每月自动扣款
                      │
                      ▼
             升级/降级/取消 → 按比例计算
```

### 5.4 需要新增的模块

| 新模块 | 职责 | 技术栈 |
|--------|------|--------|
| **crab-cloud** | 云端 API 服务 | Axum + PostgreSQL |
| **crab-portal** | 客户自助门户 (Web) | React + Vite |
| **crab-admin** | 管理后台 (Web) | React + Vite |
| **crab-billing** | 计费引擎 | Rust + Stripe SDK |

---

## 六、实施路线图

### 6.1 总体时间线

```
2025 Q1:  Phase 1 - 可收费 (SaaS 基础)
2025 Q2:  Phase 2 - 可运营 (管理后台 + 监控)
2025 Q3:  Phase 3 - 西班牙合规 (Verifactu + 本地化)
2025 Q4:  Phase 4 - 功能增强 (库存 + 会员)
2026 Q1:  Beta 测试 (西班牙餐厅)
2026 Q2:  正式上市
2027 Q1:  Verifactu 强制生效前完成认证
```

### 6.2 Phase 1: 可收费 (8-12周)

**目标**: 完成 SaaS 计费基础设施，可以开始收费

| 周次 | 任务 | 交付物 |
|------|------|--------|
| Week 1-2 | 套餐定义 | 基础/专业/企业套餐数据模型 |
| Week 3-4 | Stripe 订阅集成 | 支付 Webhook 处理 |
| Week 5-6 | 设备授权系统 | 设备数量限制、授权码 |
| Week 7-8 | 客户门户 MVP | 注册/登录/选套餐 |
| Week 9-10 | 订阅管理 | 升级/降级/取消 |
| Week 11-12 | 账单系统 | 发票生成 + 历史查看 |

### 6.3 Phase 2: 可运营 (6-8周)

**目标**: 完成运营管理能力，可以规模化

| 周次 | 任务 | 交付物 |
|------|------|--------|
| Week 13-14 | 管理后台框架 | 租户列表 + 基础 CRUD |
| Week 15-16 | 设备监控 | 在线状态 + 告警 |
| Week 17-18 | 云端数据同步 | 边缘→云端同步机制 |
| Week 19-20 | 聚合报表 | 多店统计 + 图表 |

### 6.4 Phase 3: 西班牙合规 (8-10周)

**目标**: 符合 Verifactu 法规要求

| 周次 | 任务 | 交付物 |
|------|------|--------|
| Week 21-22 | Verifactu 数据模型 | 发票哈希链设计 |
| Week 23-24 | QR 码生成 | 法定格式 QR |
| Week 25-26 | XML 序列化 | HAC/1177/2024 格式 |
| Week 27-28 | AEAT API 对接 | 实时上报 |
| Week 29-30 | 西班牙语翻译 | es-ES 完整本地化 |

### 6.5 Phase 4: 功能增强 (6-8周)

**目标**: 完善 POS 功能，提升竞争力

| 周次 | 任务 | 交付物 |
|------|------|--------|
| Week 31-34 | 库存管理 | 库存扣减 + 预警 |
| Week 35-36 | 会员系统基础 | 客户记录 + 消费历史 |
| Week 37-38 | Bizum 支付 | 西班牙移动支付 |

---

## 七、风险与依赖

### 7.1 关键风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Verifactu 技术规范变更 | 返工 | 密切关注 AEAT 公告 |
| Stripe 西班牙政策限制 | 收款受阻 | 准备 PayPal 备选 |
| 单人开发瓶颈 | 进度延迟 | 考虑外包部分前端 |

### 7.2 外部依赖

| 依赖 | 状态 | 说明 |
|------|------|------|
| Stripe 西班牙账户 | 待申请 | 需要西班牙公司实体 |
| AEAT 开发者账号 | 待申请 | Verifactu API 访问 |
| 西班牙语翻译 | 待外包 | 专业本地化服务 |

---

## 八、附录

### A. 工作量汇总

| 类别 | 工作量 |
|------|--------|
| SaaS 基础设施 (P0) | 200-300h |
| 运营管理能力 (P1) | 180-260h |
| 西班牙合规 (P0) | 200-300h |
| POS 功能增强 (P2) | 200-280h |
| **总计** | **780-1140h** |

### B. 参考资源

- [Fiskaly - Tax Compliance in Spain 2025](https://www.fiskaly.com/blog/fiscalization-in-spain-in-2025-ticketbai-anti-fraud-law-verifactu-sii-e-invoice)
- [EFSTA - Verifactu Regulations](https://www.efsta.eu/en/solutions/verifactu-regulations-and-changes)
- [Marosa VAT - Verifactu Guide](https://marosavat.com/vat-news/verifactu-spain-2026-guide)
- [HAC/1177/2024 法规原文](https://www.boe.es/buscar/act.php?id=BOE-A-2024-21867)

---

*文档生成: 2026-02-04*
*Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>*
