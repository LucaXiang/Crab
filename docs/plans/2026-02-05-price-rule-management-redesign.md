# 价格规则管理页面重设计

## 概述

将价格规则管理页面从简单列表改为 Master-Detail 布局，增加时间可视化、规则预览测试、冲突检测功能。

## 设计目标

1. **信息可视化增强** - 时间条件用周历/日期条直观展示
2. **布局重设计** - Master-Detail 左右分栏
3. **规则预览/测试** - 选择区域+商品，实时计算效果
4. **规则冲突检测** - 优先级和叠加模式可视化

## 整体布局

```
┌─────────────────────────────────────────────────────────────────────┐
│  [齿轮图标] 价格规则管理                          [+ 添加规则]      │
│  管理折扣和附加费规则                                               │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────┐  ┌──────────────────────────────────────┐ │
│  │   规则列表 (左栏)    │  │       规则详情 (右栏)                │ │
│  │   宽度: ~320px       │  │       宽度: flex-1                   │ │
│  └──────────────────────┘  └──────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

- **左栏**: 固定 320px，带内部滚动，显示规则卡片列表
- **右栏**: flex-1 占满剩余空间，显示选中规则的详情
- 左栏背景略深 (`bg-gray-50`)，右栏纯白

## 左栏 - 规则列表

### 规则卡片结构

```
┌────────────────────────────────────┐
│ 🟢 周末折扣                    -10% │  ← 状态点 + 名称 + 调整值
│ 🌍 全部商品 · 🪑 堂食              │  ← 菜品范围 + 区域范围
│ 周六日 11:00-22:00                 │  ← 时间摘要
│ 优先级: 12 · 可叠加                │  ← 优先级 + 叠加模式
└────────────────────────────────────┘
```

### 范围图标系统

**菜品范围 (ProductScope)**:
| 类型 | 图标 | 示例 |
|------|------|------|
| GLOBAL | 🌍 | 全部商品 |
| CATEGORY | 📦 | 主食 |
| TAG | 🏷️ | 热销 |
| PRODUCT | 📱 | 汉堡 |

**区域范围 (ZoneScope)**:
| 值 | 图标 | 显示 |
|----|------|------|
| zone:all | 🏠 | 全部 |
| zone:retail | 🛒 | 零售 |
| zone:xxx | 🪑 | 区域名 |

### 颜色编码

| 类型 | 颜色 |
|------|------|
| 折扣 (DISCOUNT) | `bg-amber-50 border-amber-200` 状态点 `bg-amber-500` |
| 附加费 (SURCHARGE) | `bg-purple-50 border-purple-200` 状态点 `bg-purple-500` |
| 已禁用 | `opacity-50` 状态点 `bg-gray-400` |

### 交互

- 点击整行选中该规则
- 选中状态: 左侧 3px 主题色竖条 + 浅色背景

## 右栏 - 规则详情

右栏分为四个区块：

### 1. 规则详情卡片

**查看模式**:
```
┌─────────────────────────────────────────────────────────────────────┐
│  周末加价                                           [编辑] [删除]   │
│  ────────────────────────────────────────────────────────────────── │
│                                                                     │
│  📊 规则类型                        💰 调整方式                     │
│  ┌─────────────┐                   ┌──────────────────┐             │
│  │ 附加费      │                   │ 百分比: +10%     │             │
│  └─────────────┘                   └──────────────────┘             │
│                                                                     │
│  🎯 应用范围                                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 菜品: 🌍 全部商品                                            │   │
│  │ 区域: 🪑 堂食                                                │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ⚙️ 行为设置                                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 优先级: 12  │  叠加模式: 可叠加  │  状态: ✅ 启用             │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

**编辑模式** (内嵌，点击[编辑]切换):
- 字段变为可编辑表单
- 顶部按钮变为 [取消] [保存修改]
- 不使用弹窗，保持视觉流畅

### 2. 时间可视化

```
┌─────────────────────────────────────────────────────────────────────┐
│  📅 生效时间                                                        │
│  ─────────────────────────────────────────────────────────────────  │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │     一    二    三    四    五    六    日                   │   │
│  │   ┌────┬────┬────┬────┬────┬────┬────┐                      │   │
│  │   │    │    │    │    │    │▓▓▓▓│▓▓▓▓│  11:00 ─┐           │   │
│  │   │    │    │    │    │    │▓▓▓▓│▓▓▓▓│         │           │   │
│  │   │    │    │    │    │    │▓▓▓▓│▓▓▓▓│         │ 生效      │   │
│  │   │    │    │    │    │    │▓▓▓▓│▓▓▓▓│         │           │   │
│  │   │    │    │    │    │    │▓▓▓▓│▓▓▓▓│  22:00 ─┘           │   │
│  │   └────┴────┴────┴────┴────┴────┴────┘                      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ✅ 周六、周日 11:00 - 22:00                                        │
│  日期: 2026-01-01 ~ 2026-12-31 (剩余 330 天)                       │
└─────────────────────────────────────────────────────────────────────┘
```

**触摸屏适配**:
- 不使用悬浮提示，所有信息直接用文字显示
- 周历纯展示，点击进入编辑模式可修改
- 颜色: 折扣 `bg-amber-400`，附加费 `bg-purple-400`

### 3. 规则预览测试器

```
┌─────────────────────────────────────────────────────────────────────┐
│  🧪 规则预览                                                        │
│  ─────────────────────────────────────────────────────────────────  │
│                                                                     │
│  ┌────────────────────────────┐  ┌────────────────────────────┐    │
│  │ 🏠 区域                    │  │ 🍔 商品                    │    │
│  │                            │  │                            │    │
│  │    堂食                    │  │    汉堡 · €8.50            │    │
│  │                       [选择]│  │                       [选择]│    │
│  └────────────────────────────┘  └────────────────────────────┘    │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  📊 计算结果                                                 │   │
│  │                                                              │   │
│  │   原价                                              €8.50    │   │
│  │   ───────────────────────────────────────────────────────── │   │
│  │   ✅ 命中规则:                                               │   │
│  │   🟣 周末加价                                       +€0.85   │   │
│  │      (+10%, 优先级 12, 可叠加)                               │   │
│  │   🟢 新品促销                                       -€1.00   │   │
│  │      (固定减免, 优先级 8, 可叠加)                            │   │
│  │   ───────────────────────────────────────────────────────── │   │
│  │   ❌ 未命中规则:                                             │   │
│  │   🟢 会员折扣        ← 区域不匹配 (仅零售)                   │   │
│  │   🟣 节假日加价      ← 时间不匹配 (仅节假日)                 │   │
│  │   🟢 分类折扣        ← 商品不匹配 (仅饮料分类)               │   │
│  │   ───────────────────────────────────────────────────────── │   │
│  │   最终价                                            €8.35    │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

**未命中原因类型**:
| 原因 | 显示 |
|------|------|
| 区域不匹配 | ← 区域不匹配 (仅xxx) |
| 商品不匹配 | ← 商品不匹配 (仅xxx分类/标签) |
| 时间不匹配 | ← 时间不匹配 (仅xxx) |
| 已禁用 | ← 规则已禁用 |
| 被独占规则阻止 | ← 被「xxx」独占阻止 |

**Picker Modal** (点击[选择]弹出):

区域 Picker:
- 大卡片列表，单选
- 显示: 图标 + 名称 + 描述

商品 Picker:
- 顶部搜索框
- 分类筛选标签
- 商品卡片网格 (图标 + 名称 + 价格)

### 4. 规则冲突分析

显示与当前规则可能产生交互的其他规则：

```
┌─────────────────────────────────────────────────────────────────────┐
│  ⚡ 规则交互                                                        │
│  ─────────────────────────────────────────────────────────────────  │
│                                                                     │
│  同时生效的规则 (按优先级排序):                                      │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 1. 🟢 会员折扣        -5%     优先级: 20   独占             │   │
│  │ 2. 🟣 周末加价 ← 当前 +10%    优先级: 12   可叠加           │   │
│  │ 3. 🟢 新品促销        -€2     优先级: 8    不可叠加         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  💡 提示: 会员折扣(独占)会阻止后续规则生效                          │
└─────────────────────────────────────────────────────────────────────┘
```

## 空状态

### 无规则 (整个页面)
居中显示设置图标 + "还没有价格规则" + [+ 添加规则] 按钮

### 未选中规则 (右栏)
居中显示 "请从左侧选择一个规则查看详情"

## 实现计划

1. 重构 `PriceRuleManagement.tsx` 为左右分栏布局
2. 提取 `RuleListPanel.tsx` 组件 (左栏)
3. 提取 `RuleDetailPanel.tsx` 组件 (右栏)
4. 实现 `TimeVisualization.tsx` 周历组件
5. 实现 `RulePreviewTester.tsx` 预览测试器
6. 实现 `ZonePicker.tsx` 和 `ProductPicker.tsx` Modal
7. 实现 `RuleConflictAnalysis.tsx` 冲突分析
8. 添加 `selectedRuleId` 状态管理
9. 保留现有 `PriceRuleForm` 弹窗用于创建新规则
