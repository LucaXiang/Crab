(security_headers) {
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		X-XSS-Protection "1; mode=block"
		Referrer-Policy strict-origin-when-cross-origin
		Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"
		-Server
	}
}

(csp_portal) {
	header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://cloud.redcoral.app; font-src 'self'; frame-ancestors 'none'"
}

(csp_console) {
	header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://cloud.redcoral.app https://*.amazonaws.com; connect-src 'self' https://cloud.redcoral.app wss://cloud.redcoral.app; font-src 'self'; frame-ancestors 'none'"
}

redcoral.app {
	import security_headers
	import csp_portal
	log {
		output file /var/log/caddy/access.log {
			roll_size 50MiB
			roll_keep 5
		}
		format json
	}
	root * /srv/portal
	file_server
	try_files {path} {path}.html {path}/index.html /200.html
	encode gzip

	# Immutable assets (hashed filenames) — cache aggressively
	@immutable path /_app/immutable/*
	header @immutable Cache-Control "public, max-age=31536000, immutable"

	# Other static assets — moderate cache
	@static not path /_app/immutable/*
	header @static Cache-Control "public, max-age=3600"
}

console.redcoral.app {
	import security_headers
	import csp_console
	log {
		output file /var/log/caddy/access.log {
			roll_size 50MiB
			roll_keep 5
		}
		format json
	}
	root * /srv/console
	file_server
	try_files {path} {path}.html {path}/index.html /200.html
	encode gzip

	# Vite hashed assets — cache aggressively
	@immutable path /assets/*
	header @immutable Cache-Control "public, max-age=31536000, immutable"

	# HTML / other — short cache for SPA updates
	@html path /index.html /200.html
	header @html Cache-Control "no-cache"

	@static {
		not path /assets/*
		not path /index.html
		not path /200.html
	}
	header @static Cache-Control "public, max-age=3600"
}

cloud.redcoral.app {
	import security_headers
	log {
		output file /var/log/caddy/access.log {
			roll_size 50MiB
			roll_keep 5
		}
		format json
	}
	reverse_proxy crab-cloud:8080 {
		header_up X-Real-IP {remote_host}
	}
}

updates.redcoral.app {
	import security_headers
	log {
		output file /var/log/caddy/access.log {
			roll_size 50MiB
			roll_keep 5
		}
		format json
	}
	reverse_proxy https://crab-app-updates.s3.eu-south-2.amazonaws.com {
		header_up Host crab-app-updates.s3.eu-south-2.amazonaws.com
	}
	header Cache-Control "public, max-age=300"
}
