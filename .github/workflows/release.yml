name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: true

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: release-windows

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: red_coral/package-lock.json

      - name: Install frontend dependencies
        run: npm ci --legacy-peer-deps
        working-directory: red_coral

      - name: Install NASM (for aws-lc-rs)
        uses: ilammy/setup-nasm@v1

      - name: Build Tauri app (signed for updater)
        working-directory: red_coral
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npx tauri build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: eu-south-2

      - name: Upload to S3 and generate manifest
        shell: bash
        env:
          S3_BUCKET: ${{ secrets.UPDATE_S3_BUCKET }}
          DOWNLOAD_BASE: ${{ secrets.UPDATE_DOWNLOAD_BASE_URL }}
          VERSION: ${{ github.ref_name }}
        run: |
          NSIS_DIR="target/release/bundle/nsis"

          # Upload .exe installer (for fresh installs)
          INSTALLER=$(ls ${NSIS_DIR}/*.exe 2>/dev/null | head -1)
          if [ -n "$INSTALLER" ]; then
            aws s3 cp "$INSTALLER" \
              "s3://${S3_BUCKET}/releases/${VERSION}/redcoral-pos_${VERSION}_x64-setup.exe"
          fi

          # Upload .nsis.zip (for Tauri updater)
          NSIS_ZIP=$(ls ${NSIS_DIR}/*.nsis.zip 2>/dev/null | head -1)
          if [ -n "$NSIS_ZIP" ]; then
            aws s3 cp "$NSIS_ZIP" \
              "s3://${S3_BUCKET}/updates/redcoral-pos_${VERSION}_x64-setup.nsis.zip"
          fi

          # Read updater signature
          NSIS_SIG=$(ls ${NSIS_DIR}/*.nsis.zip.sig 2>/dev/null | head -1)
          if [ -n "$NSIS_SIG" ]; then
            SIGNATURE=$(cat "$NSIS_SIG")
          else
            echo "WARNING: No .sig file found, updater verification will fail"
            SIGNATURE=""
          fi

          # Generate update manifest (Tauri updater format)
          cat > latest.json <<MANIFEST
          {
            "version": "${VERSION#v}",
            "notes": "Release ${VERSION}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "windows-x86_64": {
                "signature": "${SIGNATURE}",
                "url": "${DOWNLOAD_BASE}/updates/redcoral-pos_${VERSION}_x64-setup.nsis.zip"
              }
            }
          }
          MANIFEST

          aws s3 cp latest.json "s3://${S3_BUCKET}/updates/latest.json" \
            --content-type "application/json"

          echo ""
          echo "==> Release ${VERSION} uploaded successfully"
          echo "    Installer: s3://${S3_BUCKET}/releases/${VERSION}/"
          echo "    Updater:   s3://${S3_BUCKET}/updates/latest.json"
