name: Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: true

jobs:
  # ============================================================
  # Gate: all-platform test must pass before building release
  # ============================================================
  test:
    name: Test (${{ matrix.os }})
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Install NASM (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/setup-nasm@v1

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Clippy
        run: cargo clippy --workspace --exclude crab-cloud -- -D warnings

      - name: Test
        run: cargo nextest run --workspace --exclude crab-cloud --lib

  frontend-check:
    name: Frontend Type Check
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: red_coral/package-lock.json

      - name: Install dependencies
        working-directory: red_coral
        run: npm ci --legacy-peer-deps

      - name: TypeScript type check
        working-directory: red_coral
        run: npx tsc --noEmit

  # ============================================================
  # Build: only after ALL tests pass
  # ============================================================
  build-windows:
    name: Build Windows Installer
    needs: [test, frontend-check]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: windows-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "windows-release"
          cache-on-failure: true

      - name: Install NASM (for aws-lc-rs)
        uses: ilammy/setup-nasm@v1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: red_coral/package-lock.json

      - name: Install frontend dependencies
        run: npm ci --legacy-peer-deps
        working-directory: red_coral

      - name: Build Tauri app (signed for updater)
        working-directory: red_coral
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npx tauri build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: eu-south-2

      - name: Upload to S3 and generate manifest
        id: upload
        shell: bash
        env:
          S3_BUCKET: ${{ secrets.UPDATE_S3_BUCKET }}
          DOWNLOAD_BASE: ${{ secrets.UPDATE_DOWNLOAD_BASE_URL }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          set -euo pipefail

          # Tauri workspace member outputs to workspace root target/
          NSIS_DIR="target/release/bundle/nsis"
          if [ ! -d "$NSIS_DIR" ]; then
            NSIS_DIR="red_coral/target/release/bundle/nsis"
          fi

          echo "==> NSIS directory contents:"
          ls -la "${NSIS_DIR}/" || { echo "ERROR: NSIS dir not found"; exit 1; }

          # Upload .exe installer
          INSTALLER=$(find "${NSIS_DIR}" -maxdepth 1 -name "*.exe" ! -name "*.sig" | head -1)
          if [ -z "$INSTALLER" ]; then
            echo "ERROR: No .exe installer found in ${NSIS_DIR}"
            exit 1
          fi
          INSTALLER_NAME="redcoral-pos_${VERSION}_x64-setup.exe"
          aws s3 cp "$INSTALLER" \
            "s3://${S3_BUCKET}/releases/${VERSION}/${INSTALLER_NAME}"
          aws s3 cp "$INSTALLER" \
            "s3://${S3_BUCKET}/updates/${INSTALLER_NAME}"
          echo "Uploaded installer: $INSTALLER"

          # Read updater signature
          EXE_SIG=$(find "${NSIS_DIR}" -maxdepth 1 -name "*.exe.sig" | head -1)
          if [ -z "$EXE_SIG" ]; then
            echo "ERROR: No .exe.sig found â€” TAURI_SIGNING_PRIVATE_KEY may not be set"
            exit 1
          fi
          SIGNATURE=$(cat "$EXE_SIG")
          echo "Signature loaded from: $EXE_SIG"

          # Generate update manifest
          if [ -n "${MANDATORY_MIN_VERSION:-}" ]; then
            MANDATORY_FIELD="\"mandatory_min_version\": \"${MANDATORY_MIN_VERSION}\","
          else
            MANDATORY_FIELD=""
          fi
          PUB_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          printf '{\n  "version": "%s",\n  "notes": "Release %s",\n  "pub_date": "%s",\n  %s\n  "platforms": {\n    "windows-x86_64": {\n      "signature": "%s",\n      "url": "%s/updates/%s"\n    }\n  }\n}\n' \
            "${VERSION#v}" "${VERSION}" "${PUB_DATE}" "${MANDATORY_FIELD}" "${SIGNATURE}" "${DOWNLOAD_BASE}" "${INSTALLER_NAME}" \
            > latest.json

          aws s3 cp latest.json "s3://${S3_BUCKET}/updates/latest.json" \
            --content-type "application/json"

          echo ""
          echo "==> Release ${VERSION} uploaded successfully"
          echo "    Installer: s3://${S3_BUCKET}/releases/${VERSION}/"
          echo "    Updater:   s3://${S3_BUCKET}/updates/latest.json"

          echo "INSTALLER_PATH=${INSTALLER}" >> "$GITHUB_OUTPUT"
          echo "INSTALLER_NAME=${INSTALLER_NAME}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          gh release create "$VERSION" \
            --title "RedCoral POS $VERSION" \
            --generate-notes \
            --draft \
            "${{ steps.upload.outputs.INSTALLER_PATH }}#${{ steps.upload.outputs.INSTALLER_NAME }}"

  # ============================================================
  # Cache warming: main branch only (no tests needed)
  # ============================================================
  warm-cache:
    name: Warm Release Cache
    if: github.ref == 'refs/heads/main'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "windows-release"
          cache-on-failure: true

      - name: Install NASM (for aws-lc-rs)
        uses: ilammy/setup-nasm@v1

      - name: Warm Rust release build
        working-directory: red_coral
        run: |
          mkdir -p dist
          echo "<html></html>" > dist/index.html
          cd src-tauri
          cargo build --release
