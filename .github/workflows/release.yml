name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  SQLX_OFFLINE: true

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: red_coral/package-lock.json

      - name: Install frontend dependencies
        run: npm ci --legacy-peer-deps
        working-directory: red_coral

      - name: Install NASM (for aws-lc-rs)
        uses: ilammy/setup-nasm@v1

      - name: Build Tauri app (signed for updater)
        working-directory: red_coral
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npx tauri build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: eu-south-2

      - name: Upload to S3 and generate manifest
        shell: bash
        env:
          S3_BUCKET: ${{ secrets.UPDATE_S3_BUCKET }}
          DOWNLOAD_BASE: ${{ secrets.UPDATE_DOWNLOAD_BASE_URL }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          set -euo pipefail
          NSIS_DIR="red_coral/target/release/bundle/nsis"

          echo "==> NSIS directory contents:"
          ls -la "${NSIS_DIR}/" || { echo "ERROR: NSIS dir not found"; exit 1; }

          # Upload .exe installer (for fresh installs)
          INSTALLER=$(find "${NSIS_DIR}" -maxdepth 1 -name "*.exe" | head -1)
          if [ -z "$INSTALLER" ]; then
            echo "ERROR: No .exe installer found in ${NSIS_DIR}"
            exit 1
          fi
          aws s3 cp "$INSTALLER" \
            "s3://${S3_BUCKET}/releases/${VERSION}/redcoral-pos_${VERSION}_x64-setup.exe"
          echo "Uploaded installer: $INSTALLER"

          # Upload .nsis.zip (for Tauri updater)
          NSIS_ZIP=$(find "${NSIS_DIR}" -maxdepth 1 -name "*.nsis.zip" | head -1)
          if [ -z "$NSIS_ZIP" ]; then
            echo "ERROR: No .nsis.zip found — TAURI_SIGNING_PRIVATE_KEY may not be set"
            exit 1
          fi
          aws s3 cp "$NSIS_ZIP" \
            "s3://${S3_BUCKET}/updates/redcoral-pos_${VERSION}_x64-setup.nsis.zip"
          echo "Uploaded updater zip: $NSIS_ZIP"

          # Read updater signature
          NSIS_SIG=$(find "${NSIS_DIR}" -maxdepth 1 -name "*.nsis.zip.sig" | head -1)
          if [ -z "$NSIS_SIG" ]; then
            echo "ERROR: No .sig file found — updater verification will fail"
            exit 1
          fi
          SIGNATURE=$(cat "$NSIS_SIG")
          echo "Signature loaded from: $NSIS_SIG"

          # Generate update manifest (Tauri updater format)
          printf '{\n  "version": "%s",\n  "notes": "Release %s",\n  "pub_date": "%s",\n  "platforms": {\n    "windows-x86_64": {\n      "signature": "%s",\n      "url": "%s/updates/redcoral-pos_%s_x64-setup.nsis.zip"\n    }\n  }\n}\n' \
            "${VERSION#v}" "$VERSION" "$(date -u +%Y-%m-%dT%H:%M:%SZ)" "$SIGNATURE" "$DOWNLOAD_BASE" "$VERSION" \
            > latest.json

          aws s3 cp latest.json "s3://${S3_BUCKET}/updates/latest.json" \
            --content-type "application/json"

          echo ""
          echo "==> Release ${VERSION} uploaded successfully"
          echo "    Installer: s3://${S3_BUCKET}/releases/${VERSION}/"
          echo "    Updater:   s3://${S3_BUCKET}/updates/latest.json"
