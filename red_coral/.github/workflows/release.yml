name: Tauri Release (Windows Only)

# æƒé™é…ç½®ï¼šå…è®¸å†™å…¥ contents ä»¥åˆ›å»º Release
permissions:
  contents: write

# è§¦å‘æ¡ä»¶: å½“åˆ›å»ºä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  release:
    # æ„å»ºç­–ç•¥ï¼šä»…é’ˆå¯¹ Windows å¹³å°
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]
    
    # ä½¿ç”¨çŸ©é˜µä¸­çš„å¹³å°ä½œä¸ºè¿è¡Œç¯å¢ƒ
    runs-on: ${{ matrix.platform }}
    
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # 1. Rust Toolchain Setup
      # ä½¿ç”¨ç¨³å®šçš„ Rust ç‰ˆæœ¬
      - name: âš™ï¸ Rust setup
        uses: dtolnay/rust-toolchain@stable

      # 2. Rust ç¼–è¯‘ç¼“å­˜ (æœ€é‡è¦åŠ é€Ÿç‚¹)
      - name: ğŸ“¦ Rust cache
        uses: swatinem/rust-cache@v2
        with:
          # æŒ‡å®šå·¥ä½œç›®å½•ä¸º src-tauri
          workspaces: 'src-tauri -> target'
          # ç¼“å­˜é”®å‰ç¼€ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ä»¥å¼ºåˆ¶åˆ·æ–°ç¼“å­˜
          prefix-key: "v1-rust"
          # å…±äº«å¯†é’¥ï¼Œå…è®¸åœ¨ä¸åŒ Job é—´å…±äº«ç¼“å­˜
          shared-key: "windows-release"
          # ä»…ç¼“å­˜ Cargo.lock é”å®šçš„ä¾èµ–
          cache-on-failure: true

      # 3. Node.js Setup & npm ä¾èµ–ç¼“å­˜ (ä»… Tag éœ€è¦)
      - name: âš™ï¸ Node.js setup and npm cache
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      # 4. å®‰è£…å‰ç«¯ä¾èµ– (ä»… Tag éœ€è¦)
      - name: ğŸ“¦ Install frontend dependencies
        if: startsWith(github.ref, 'refs/tags/v')
        # ä½¿ç”¨ --frozen-lockfile ä»¥ç¡®ä¿å®‰è£…çš„ä¾èµ–ä¸ lockfile ä¸€è‡´ï¼Œæå‡ç¨³å®šæ€§
        # å¢åŠ  --prefer-offline å°è¯•åˆ©ç”¨æœ¬åœ°ç¼“å­˜
        run: npm ci --prefer-offline

      # 5a. ä»…åœ¨ main åˆ†æ”¯è¿è¡Œæ—¶é¢„çƒ­ Rust ç¼“å­˜ (è·³è¿‡å‰ç«¯æ„å»º)
      # åˆ›å»º dummy dist ç›®å½•ä»¥ç»•è¿‡ tauri-build æ£€æŸ¥
      - name: ğŸ”¨ Build Rust Only (Cache Warming)
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p dist
          touch dist/index.html
          cd src-tauri
          cargo build --release

      # 5b. æ„å»º Tauri åº”ç”¨å¹¶åˆ›å»º GitHub Release (ä»…åœ¨ Tag æ—¶è¿è¡Œ)
      - name: ğŸ”¨ Build and Release the app
        if: startsWith(github.ref, 'refs/tags/v')
        # ä½¿ç”¨ tauri-action æ¥å¤„ç†è·¨å¹³å°æ„å»ºã€ç­¾åå’Œä¸Šä¼ èµ„äº§
        uses: tauri-apps/tauri-action@v0
        env:
          # GITHUB_TOKEN æ˜¯å¿…éœ€çš„ï¼Œç”¨äºåˆ›å»º Release
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # ğŸ’¡ å»ºè®®æ·»åŠ ç¯å¢ƒå˜é‡æ¥å®šä¹‰ Windows æ„å»ºç›®æ ‡ (å¯é€‰)
          # TAURI_TARGET: x86_64-pc-windows-msvc 
        with:
          # ä½¿ç”¨æ ‡ç­¾åä½œä¸º Release çš„æ ‡ç­¾
          tagName: ${{ github.ref_name }}
          # è‡ªåŠ¨æ›¿æ¢ __VERSION__ ä¸º Cargo.toml ä¸­çš„ç‰ˆæœ¬å·
          releaseName: 'App Release ${{ github.ref_name }}' 
          releaseBody: 'See the assets to download this version and install.'
          # é€šå¸¸åœ¨ CI/CD ä¸­ï¼Œæ‚¨ä¼šå¸Œæœ›è‰ç¨¿ä¸º falseï¼Œè¿™é‡Œä¿ç•™æ‚¨åŸæœ‰çš„ true
          releaseDraft: true
          prerelease: false